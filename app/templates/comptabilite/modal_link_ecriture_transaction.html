<!-- Modal pour lier une écriture à une transaction -->
<div class="modal fade show" id="linkModal" tabindex="-1" aria-labelledby="linkModalLabel" aria-hidden="false"
    style="display: block; background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="linkModalLabel">
                    {% if ecriture_link.transaction_id %}
                    Modifier le lien avec la transaction
                    {% else %}
                    Lier cette écriture à une transaction
                    {% endif %}
                </h5>
                <!-- Bouton fermer -->
                <a href="{{ url_for(request.endpoint,
                          compte_id=request.args.get('compte_id'),
                          date_from=request.args.get('date_from'),
                          date_to=request.args.get('date_to'),
                          id_contact=request.args.get('id_contact'),
                          statut=request.args.get('statut'),
                          categorie_id=request.args.get('categorie_id')) }}" class="btn-close btn-close-white"
                    aria-label="Fermer">
                </a>
            </div>
            <div class="modal-body">
                <p><strong>Écriture :</strong> {{ ecriture_link.description or '—' }} ({{
                    "%.2f"|format(ecriture_link.montant) }} CHF)</p>

                {% if ecriture_link.transaction_id %}
                <p><strong>Actuellement liée à :</strong> Transaction #{{ ecriture_link.transaction_id }}</p>
                <form method="POST" action="{{ url_for('banking.unlink_ecriture') }}">
                    <input type="hidden" name="ecriture_id" value="{{ ecriture_link.id }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-unlink"></i> Délier
                    </button>
                </form>
                <hr>
                {% endif %}

                <form method="POST" action="{{ url_for('banking.relink_ecriture') }}">
                    <input type="hidden" name="ecriture_id" value="{{ ecriture_link.id }}">
                    <div class="mb-3">
                        <label class="form-label">Choisir une transaction</label>
                        <select class="form-select" name="new_transaction_id" required>
                            <option value="">-- Sélectionner --</option>
                            {% for tx in transactions_eligibles %}
                            <option value="{{ tx.id }}" {% if tx.id==ecriture_link.transaction_id %}selected{% endif %}>
                                #{{ tx.id }} – {{ "%.2f"|format(tx.montant) }} CHF - {% if tx.total_ecritures > 0 %} -  {{ tx.date_transaction.strftime('%d.%m.%Y') }} –
                                {{ tx.description or '–' }}
                                
                                <small class="text-muted">(déjà liées : {{ "%.2f"|format(tx.total_ecritures) }}
                                    CHF)</small>
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-link"></i> Lier à cette transaction
                        </button>
                        <a href="{{ url_for(request.endpoint,
                                    compte_id=request.args.get('compte_id'),
                                    date_from=request.args.get('date_from'),
                                    date_to=request.args.get('date_to'),
                                    id_contact=request.args.get('id_contact'),
                                    statut=request.args.get('statut'),
                                    categorie_id=request.args.get('categorie_id')) }}" class="btn btn-secondary">
                            Annuler
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>