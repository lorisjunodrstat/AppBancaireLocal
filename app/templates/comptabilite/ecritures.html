{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Écritures comptables</h2>

    <!-- Filtres -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="compte_id" class="form-label">Compte bancaire</label>
                    <select id="compte_id" name="compte_id" class="form-select">
                        <option value="">Tous les comptes</option>
                        {% for compte in comptes %}
                        <option value="{{ compte.id }}" {% if compte.id==compte_selectionne|int %}selected{% endif %}>
                            {{ compte.nom_compte }} ({{ compte.nom_banque }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="date_from" class="form-label">Du</label>
                    <input type="date" id="date_from" name="date_from" class="form-control"
                        value="{{ request.args.get('date_from', '') }}">
                </div>
                <div class="col-md-3">
                    <label for="date_to" class="form-label">Au</label>
                    <input type="date" id="date_to" name="date_to" class="form-control"
                        value="{{ request.args.get('date_to', '') }}">
                </div>
                <div class="col-md-3">
                    <label for="id_contact" class="form-label">Contact</label>
                    <select id="id_contact" name="id_contact" class="form-select">
                        <option value="">Tous les contacts</option>
                        {% for contact in contacts %}
                        <option value="{{ contact.id_contact }}" {% if contact.id_contact==contact_selectionne|int
                            %}selected{% endif %}>
                            {{ contact.nom }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="categorie_id" class="form-label">Catégorie comptable</label>
                    <select id="categorie_id" name="categorie_id" class="form-select">
                        <option value="">Toutes les catégories</option>
                        {% for categorie in categories %}
                        <option value="{{ categorie.id }}" {% if categorie.id==categorie_id|int %}selected{% endif %}>
                            {{ categorie.numero }} - {{ categorie.nom }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="statut" class="form-label">Statut</label>
                    <select id="statut" name="statut" class="form-select">
                        {% for statut in statuts_disponibles %}
                        <option value="{{ statut.value }}" {% if statut.value==statut_selectionne %}selected{% endif %}>
                            {{ statut.label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary">Filtrer</button>
                    <a href="{{ url_for('banking.liste_ecritures') }}"
                        class="btn btn-outline-secondary ms-2">Réinitialiser</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Tableau des écritures -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Historique des écritures</h5>
            <a href="{{ url_for('banking.nouvelle_ecriture') }}" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> Nouvelle écriture
            </a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Compte</th>
                            <th>Catégorie</th>
                            <th>Description</th>
                            <th>Contact</th>
                            <th class="text-end">Montant</th>
                            <th>Fichier</th>
                            <th>Actions</th>
                            <th>Statut</th>
                            <th>Liaison</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ecriture in ecritures %}
                        <tr
                            class="{% if ecriture.type_ecriture == 'recette' %}table-success{% else %}table-danger{% endif %}">
                            <td>{{ ecriture.date_ecriture.strftime('%d.%m.%Y') }}</td>
                            <td>{{ ecriture.compte_bancaire_nom }}</td>
                            <td>
                                <span class="badge bg-secondary">{{ ecriture.categorie_numero }}</span>
                                {{ ecriture.categorie_nom }}
                            </td>
                            <td>{{ ecriture.description }}</td>
                            <td>
                                {% if ecriture.id_contact and ecriture.id_contact in contact_map %}
                                {{ contact_map[ecriture.id_contact] }}
                                {% elif ecriture.id_contact %}
                                {{ ecriture.id_contact }}
                                {% else %}
                                —
                                {% endif %}
                            </td>
                            <td class="text-end fw-bold">
                                {{ "%.2f"|format(ecriture.montant) }} {{ ecriture.devise }}
                            </td>

                            <!-- Colonne Fichier -->
                            <td>
                                {% if ecriture.nom_fichier %}
                                <!-- Icône pour visualiser le fichier -->
                                <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal"
                                    data-bs-target="#modalFichier{{ ecriture.id }}">
                                    <i class="bi bi-file-earmark"></i>
                                </button>

                                <!-- Lien de téléchargement -->
                                <a href="{{ url_for('banking.download_fichier_ecriture', ecriture_id=ecriture.id) }}"
                                    class="btn btn-sm btn-outline-success" title="Télécharger">
                                    <i class="bi bi-download"></i>
                                </a>
                                {% else %}
                                <!-- Bouton pour ajouter un fichier -->
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal"
                                    data-bs-target="#modalUpload{{ ecriture.id }}">
                                    <i class="bi bi-upload"></i>
                                </button>
                                {% endif %}
                            </td>

                            <!-- Actions -->
                            <td>
                                <div class="btn-group">
                                    <!-- Édition -->
                                    <a href="{{ url_for('banking.edit_ecriture', ecriture_id=ecriture.id) }}"
                                        class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-pencil"></i>
                                    </a>

                                    <!-- Suppression -->
                                    <form action="{{ url_for('banking.delete_ecriture', ecriture_id=ecriture.id) }}"
                                        method="post" class="d-inline"
                                        onsubmit="return confirm('Supprimer cette écriture ?');">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>

                            <!-- Statut avec Modal -->
                            <td>
                                <button type="button"
                                    class="btn btn-sm {% if ecriture.statut == 'validée' %}btn-success{% elif ecriture.statut == 'rejetée' %}btn-danger{% else %}btn-warning{% endif %}"
                                    data-bs-toggle="modal" data-bs-target="#modalStatut{{ ecriture.id }}">
                                    {{ ecriture.statut }}
                                </button>
                            </td>

                            <!-- Liaison Transaction -->
                            <td>
                                {% if ecriture.transaction_id %}
                                <a href="{{ url_for('banking.liste_ecritures',
                                                        show_transaction_modal=1,
                                                        transaction_id=ecriture.transaction_id,
                                                        compte_id=request.args.get('compte_id'),
                                                        date_from=request.args.get('date_from'),
                                                        date_to=request.args.get('date_to'),
                                                        id_contact=request.args.get('id_contact'),
                                                        statut=request.args.get('statut'),
                                                        categorie_id=request.args.get('categorie_id')) }}"
                                    class="badge bg-success text-white text-decoration-none"
                                    title="Voir les détails de la transaction">
                                    Liée #{{ ecriture.transaction_id }}
                                </a>
                                {% else %}
                                <span class="badge bg-secondary">Non liée</span>
                                <a href="{{ url_for('banking.liste_ecritures',
                                                        show_link_modal=1,
                                                        ecriture_id=ecriture.id,
                                                        compte_id=request.args.get('compte_id'),
                                                        date_from=request.args.get('date_from'),
                                                        date_to=request.args.get('date_to'),
                                                        id_contact=request.args.get('id_contact'),
                                                        statut=request.args.get('statut'),
                                                        categorie_id=request.args.get('categorie_id')) }}"
                                    class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-link"></i>
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center">Aucune écriture trouvée</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modals pour chaque écriture -->
{% for ecriture in ecritures %}
<!-- Modal pour changement de statut -->
<div class="modal fade" id="modalStatut{{ ecriture.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Changer le statut</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('banking.update_statut_ecriture', ecriture_id=ecriture.id) }}" method="post">
                <div class="modal-body">
                    <p class="mb-3"><strong>Écriture:</strong> {{ ecriture.description }}</p>
                    <p class="mb-3"><strong>Montant:</strong> {{ "%.2f"|format(ecriture.montant) }} CHF</p>

                    <div class="mb-3">
                        <label class="form-label">Nouveau statut:</label>
                        <select name="statut" class="form-select" required>
                            <option value="pending" {% if ecriture.statut=='pending' %}selected{% endif %}>En attente
                            </option>
                            <option value="validée" {% if ecriture.statut=='validée' %}selected{% endif %}>Validée
                            </option>
                            <option value="rejetée" {% if ecriture.statut=='rejetée' %}selected{% endif %}>Rejetée
                            </option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Commentaire (optionnel):</label>
                        <textarea name="commentaire" class="form-control" rows="2"
                            placeholder="Raison du changement..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Mettre à jour</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal pour upload de fichier -->
<div class="modal fade" id="modalUpload{{ ecriture.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter un fichier</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('banking.upload_fichier_ecriture', ecriture_id=ecriture.id) }}" method="post"
                enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="fichier{{ ecriture.id }}" class="form-label">Fichier (PDF, PNG, JPG - max
                            10MB)</label>
                        <input type="file" class="form-control" id="fichier{{ ecriture.id }}" name="fichier"
                            accept=".pdf,.png,.jpg,.jpeg" required>
                        <div class="form-text">
                            Formats acceptés: PDF, PNG, JPG, JPEG (max 10MB)
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Uploader</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal pour visualisation de fichier -->

{% if ecriture.nom_fichier %}
<div class="modal fade" id="modalFichier{{ ecriture.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Fichier joint: {{ ecriture.nom_fichier }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                {% if ecriture.type_mime and ecriture.type_mime.startswith('image/') %}
                <!-- Affichage d'image -->
                <div class="text-center p-3">
                    <img src="{{ url_for('banking.view_fichier_ecriture', ecriture_id=ecriture.id) }}"
                        class="img-fluid rounded" alt="{{ ecriture.nom_fichier }}" style="max-height: 70vh;"
                        onerror="this.style.display='none'; document.getElementById('fallback{{ ecriture.id }}').style.display='block';">
                </div>
                <div id="fallback{{ ecriture.id }}" class="alert alert-warning text-center m-3" style="display:none;">
                    <i class="bi bi-file-earmark fs-1"></i>
                    <p class="mt-2">Impossible d'afficher l'image</p>
                    <p>Téléchargez le fichier pour le visualiser</p>
                </div>

                {% elif ecriture.type_mime == 'application/pdf' %}
                <!-- Affichage PDF avec embed -->
                <div class="embed-container">
                    <embed
                        src="{{ url_for('banking.view_fichier_ecriture', ecriture_id=ecriture.id) }}#toolbar=1&navpanes=1&scrollbar=1"
                        type="application/pdf" width="100%" height="600px" />
                </div>

                {% else %}
                <!-- Autres types de fichiers -->
                <div class="alert alert-info text-center m-3">
                    <i class="bi bi-file-earmark fs-1"></i>
                    <p class="mt-2">Prévisualisation non disponible</p>
                    <p>Type de fichier: {{ ecriture.type_mime or 'Inconnu' }}</p>
                    <p>Téléchargez le fichier pour le visualiser</p>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <!-- Affichage dans le navigateur -->
                <a href="{{ url_for('banking.view_fichier_ecriture', ecriture_id=ecriture.id) }}"
                    class="btn btn-outline-primary" target="_blank">
                    <i class="bi bi-eye"></i> Ouvrir
                </a>

                <!-- Téléchargement -->
                <a href="{{ url_for('banking.download_fichier_ecriture', ecriture_id=ecriture.id) }}"
                    class="btn btn-success" download>
                    <i class="bi bi-download"></i> Télécharger
                </a>

                <!-- Suppression -->
                <form action="{{ url_for('banking.supprimer_fichier_ecriture', ecriture_id=ecriture.id) }}"
                    method="post" class="d-inline" onsubmit="return confirm('Supprimer ce fichier ?');">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Supprimer
                    </button>
                </form>

                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<!-- Modals existants pour liaison et transactions -->
{% if show_link_modal and ecriture_link %}
{% include 'comptabilite/modal_link_ecriture_transaction.html' %}
{% endif %}

{% if show_transaction_modal and transaction_detail %}
{% include 'comptabilite/_modal_transaction_detail.html' %}
{% endif %}

<!-- Styles pour améliorer l'affichage -->
<style>
    .modal-lg {
        max-width: 900px;
    }

    .img-fluid {
        max-height: 70vh;
        width: auto;
    }

    .btn-group .btn {
        margin-right: 2px;
    }

    .btn-group .btn:last-child {
        margin-right: 0;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.075);
    }
</style>
{% endblock %}