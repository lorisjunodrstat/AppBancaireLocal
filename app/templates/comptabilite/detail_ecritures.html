{% extends "base.html" %}

{% block head_css %}
<style>
    .ecriture-secondaire {
        background-color: #f8f9fa;
        border-left: 4px solid #6c757d;
    }

    .ecriture-principale {
        border-left: 4px solid #0d6efd;
    }

    .badge-secondaire {
        font-size: 0.7em;
        margin-left: 8px;
    }

    .montant-secondaire {
        color: #6c757d;
        font-style: italic;
    }

    .indentation-secondaire {
        padding-left: 2rem;
    }

    .icon-secondaire {
        color: #6c757d;
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{{ titre }}</h2>
        <a href="{{ url_for('banking.compte_de_resultat', annee=annee) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Retour au compte de résultat
        </a>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Détail des écritures</h5>
                <span class="badge bg-primary">Total: {{ "%.2f"|format(total) }} CHF</span>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Catégorie</th>
                            <th>Référence</th>
                            <th>Contact</th>
                            <th class="text-end">Montant (CHF)</th>
                            <th>Type</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ecriture in ecritures %}
                        <!-- Ligne de l'écriture principale -->
                        <tr class="ecriture-principale">
                            <td>{{ ecriture.date_ecriture.strftime('%d.%m.%Y') if ecriture.date_ecriture is string else
                                ecriture.date_ecriture.strftime('%d.%m.%Y') }}</td>
                            <td>
                                {{ ecriture.description or '' }}
                                {% if ecriture.has_secondaires %}
                                <span class="badge bg-info badge-secondaire">
                                    {{ ecriture.ecritures_secondaires|length }} secondaire(s)
                                </span>
                                {% endif %}
                            </td>
                            <td>{{ ecriture.categorie_nom or '' }}</td>
                            <td>{{ ecriture.reference or '' }}</td>
                            <td>
                                {% if ecriture.contact_nom %}
                                {{ ecriture.contact_nom }}
                                {% else %}
                                —
                                {% endif %}
                            </td>
                            <td class="text-end fw-bold">{{ "%.2f"|format(ecriture.montant) }}</td>
                            <td>
                                <span
                                    class="badge {% if ecriture.type_ecriture == 'recette' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ ecriture.type_ecriture }}
                                </span>
                                {% if ecriture.type_ecriture_comptable %}
                                <br>
                                <small class="text-muted">{{ ecriture.type_ecriture_comptable }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <span
                                    class="badge bg-{% if ecriture.statut == 'validée' %}success{% elif ecriture.statut == 'rejetée' %}danger{% else %}warning{% endif %}">
                                    {{ ecriture.statut }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group">
                                    <!-- Lien vers le détail complet -->
                                    {% if ecriture.has_secondaires %}
                                    <a href="{{ url_for('banking.details_ecriture_secondaires', ecriture_id=ecriture.id) }}"
                                        class="btn btn-sm btn-outline-info"
                                        title="Voir le détail avec les écritures secondaires">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% endif %}

                                    <!-- Lien pour lier à une transaction -->
                                    <a href="{{ url_for('banking.detail_ecritures_categorie', type=type, categorie_id=categorie_id) }}?annee={{ annee }}&show_link_modal=1&ecriture_id={{ ecriture.id }}"
                                        class="btn btn-sm btn-outline-primary" title="Lier à une transaction">
                                        <i class="fas fa-link"></i>
                                    </a>

                                    <!-- Lien pour éditer -->
                                    <a href="{{ url_for('banking.edit_ecriture', ecriture_id=ecriture.id) }}"
                                        class="btn btn-sm btn-outline-secondary" title="Modifier l'écriture">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>

                        <!-- Écritures secondaires - affichées directement -->
                        {% if ecriture.has_secondaires %}
                        {% for secondaire in ecriture.ecritures_secondaires %}
                        <tr class="ecriture-secondaire">
                            <td>{{ secondaire.date_ecriture.strftime('%d.%m.%Y') if secondaire.date_ecriture is string
                                else secondaire.date_ecriture.strftime('%d.%m.%Y') }}</td>
                            <td class="indentation-secondaire">
                                <i class="fas fa-arrow-right icon-secondaire"></i>
                                {{ secondaire.description or '' }}
                            </td>
                            <td>
                                {{ secondaire.categorie_nom or '' }}
                                <br>
                                <small class="text-muted">{{ secondaire.categorie_numero or '' }}</small>
                            </td>
                            <td>{{ secondaire.reference or '' }}</td>
                            <td>
                                {% if secondaire.id_contact and secondaire.id_contact in contact_map %}
                                {{ contact_map[secondaire.id_contact] }}
                                {% else %}
                                —
                                {% endif %}
                            </td>
                            <td class="text-end montant-secondaire">
                                {{ "%.2f"|format(secondaire.montant) }}
                            </td>
                            <td>
                                <span
                                    class="badge {% if secondaire.type_ecriture == 'recette' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ secondaire.type_ecriture }}
                                </span>
                                <br>
                                <small class="text-muted">secondaire</small>
                            </td>
                            <td>
                                <span
                                    class="badge bg-{% if secondaire.statut == 'validée' %}success{% elif secondaire.statut == 'rejetée' %}danger{% else %}warning{% endif %}">
                                    {{ secondaire.statut }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="{{ url_for('banking.detail_ecriture_secondaire', ecriture_secondaire_id=secondaire.id) }}"
                                        class="btn btn-sm btn-outline-info" title="Voir le détail">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ url_for('banking.edit_ecriture', ecriture_id=secondaire.id) }}"
                                        class="btn btn-sm btn-outline-secondary" title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}

                        <!-- Ligne de séparation visuelle -->
                        <tr>
                            <td colspan="9" class="p-1 bg-light"></td>
                        </tr>
                        {% endif %}
                        {% else %}
                        <tr>
                            <td colspan="9" class="text-center text-muted">Aucune écriture trouvée</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="fw-bold table-light">
                            <td colspan="5" class="text-end">Total {{ titre }}:</td>
                            <td class="text-end">{{ "%.2f"|format(total) }} CHF</td>
                            <td colspan="3"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Légende pour aider à la compréhension -->
            <div class="mt-4 p-3 bg-light rounded">
                <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>Légende des écritures</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-1">
                            <div class="border-left-primary me-2"
                                style="width: 20px; height: 20px; border-left: 4px solid #0d6efd;"></div>
                            <span>Écriture principale</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="border-left-secondary me-2"
                                style="width: 20px; height: 20px; border-left: 4px solid #6c757d;"></div>
                            <span>Écriture secondaire (générée automatiquement)</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-1">
                            <span class="badge bg-info me-1">+N secondaire(s)</span>
                            <span>Indique le nombre d'écritures secondaires liées</span>
                        </div>
                        <div>
                            <span class="badge bg-success me-1">recette</span>
                            <span class="badge bg-danger me-1">dépense</span>
                            <span>Type d'écriture comptable</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if show_link_modal and ecriture_link %}
{% include 'comptabilite/modal_link_ecriture_transaction.html' %}
{% endif %}
{% endblock %}