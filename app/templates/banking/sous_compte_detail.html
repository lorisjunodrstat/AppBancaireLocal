{% extends "base.html" %}
{% block extra_css %}
<style>
    .graphique-container {
        max-width: 600px;
        margin: 1rem auto;
    }

    .graphique-svg {
        width: 100%;
        height: auto;
        display: block;

        aspect-ratio: {
                {
                largeur_svg
            }
        }

        / {
                {
                hauteur_svg
            }
        }

        ;
        max-width: 100%;
        max-height: 70vh;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #f9f9f9;
    }
</style>
{% endblock %}
{% block title %}{{ sous_compte.nom_sous_compte }} - {{ compte.nom_compte }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Navigation -->
        <div class="row mt-4">
            <div class="col-12">
                <a href="{{ url_for('banking.banking_compte_detail', compte_id=compte.id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Retour au compte principal
                </a>
            </div>
        </div>
        <!-- En-tête du sous-compte -->
        <div class="card mb-4" style="border-top: 4px solid {{ sous_compte.couleur }};">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center mb-2">
                            <div class="rounded-circle d-inline-flex align-items-center justify-content-center me-3"
                                style="width: 50px; height: 50px; background-color: {{ sous_compte.couleur }};">
                                <i class="fas fa-{{ sous_compte.icone }} text-white fa-lg"></i>
                            </div>
                            <div>
                                <h2 class="mb-0">{{ sous_compte.nom_sous_compte }}</h2>
                                <p class="text-muted mb-0">{{ compte.nom_compte }} • {{ compte.nom_banque }}</p>
                            </div>
                        </div>

                        <p class="text-muted">{{ sous_compte.description or 'Aucune description fournie' }}</p>
                    </div>

                    <div class="col-md-4 text-end">
                        <div class="mb-2">
                            <small class="text-muted">Solde épargne</small>
                            <h3 class="mb-0">{{ "%.2f"|format(sous_compte.solde) }} {{ compte.devise }}</h3>
                        </div>
                        {% if sous_compte.objectif_montant %}
                        <div class="mb-3">
                            <small class="text-muted">Objectif</small>
                            <h4 class="mb-0 text-success">{{ "%.2f"|format(sous_compte.objectif_montant) }} {{
                                compte.devise }}</h4>
                        </div>
                        {% endif %}

                        <div class="btn-group">
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                data-bs-target="#modalRetraitSousCompte{{ sous_compte.id }}">
                                <i class="fas fa-arrow-left me-1"></i>Retirer
                            </button>
                            <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal"
                                data-bs-target="#modalAlimentationSousCompte{{ sous_compte.id }}">
                                <i class="fas fa-arrow-right me-1"></i>Alimenter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progression vers objectif -->
        {% if sous_compte.objectif_montant and sous_compte.objectif_montant > 0 %}
        {% set pourcentage_objectif = (sous_compte.solde / sous_compte.objectif_montant * 100) %}
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-bullseye me-2"></i>Progression de l'objectif</h5>
            </div>
            <div class="card-body">
                <div class="mb-2 d-flex justify-content-between">
                    <span>Objectif: {{ "%.0f"|format(sous_compte.objectif_montant) }} {{ compte.devise }} : il manque
                        <strong>{{ "%.2f"|format(sous_compte.objectif_montant - sous_compte.solde) }} {{ compte.devise
                            }}</strong> </span>
                    <span>{{ "%.1f"|format(pourcentage_objectif) }}%</span>
                </div>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar"
                        style="width: {{ pourcentage_objectif }}%; background-color: {{ sous_compte.couleur }};"></div>
                </div>
                {% if sous_compte.date_objectif %}
                <p class="text-muted small mt-2">
                    <i class="fas fa-calendar-alt me-1"></i>
                    Objectif prévu le {{ sous_compte.date_objectif.strftime('%d/%m/%Y') }}
                </p>
                {% endif %}
            </div>
        </div>
        {% endif %}
        <!-- Section filtre de la période-->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-calendar me-2"></i> Sélection de la période</h5>
                        <span class="badge bg-primary">{{ libelle_periode }}</span>
                    </div>
                    <div class="card-body">
                        <form method="GET" class="period-form">
                            <!-- Champs cachés pour conserver les autres paramètres -->
                            <input type="hidden" name="sort" value="{{ request.args.get('sort', 'date_desc') }}">
                            <input type="hidden" name="filter_type" value="{{ request.args.get('filter_type', 'tous') }}">
                            <input type="hidden" name="filter_min_amount"
                                value="{{ request.args.get('filter_min_amount', '') }}">
                            <input type="hidden" name="filter_max_amount"
                                value="{{ request.args.get('filter_max_amount', '') }}">
                            <input type="hidden" name="search" value="{{ request.args.get('search', '') }}">
        
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label for="periode" class="form-label">Type de période</label>
                                    <select class="form-select" id="periode" name="periode">
                                        <option value="mois" {% if request.args.get('periode', 'mois' )=='mois' %}selected{%
                                            endif %}>Ce mois</option>
                                        <option value="trimestre" {% if request.args.get('periode')=='trimestre' %}selected{%
                                            endif %}>Ce trimestre</option>
                                        <option value="annee" {% if request.args.get('periode')=='annee' %}selected{% endif %}>
                                            Cette année</option>
                                        <option value="mois_annee" {% if request.args.get('periode')=='mois_annee' %}selected{%
                                            endif %}>Mois/Année spécifique</option>
                                        <option value="personnalisee" {% if request.args.get('periode')=='personnalisee'
                                            %}selected{% endif %}>Période personnalisée</option>
                                    </select>
                                </div>
        
                                <!-- Options pour mois/année spécifique -->
                                <div class="col-md-5 mb-3 {% if request.args.get('periode') != 'mois_annee' %}d-none{% endif %}"
                                    id="moisAnneeContainer">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="mois_select" class="form-label">Mois</label>
                                            <select class="form-select" id="mois_select" name="mois_select">
                                                <option value="">Sélectionner un mois</option>
                                                <option value="1" {% if request.args.get('mois_select')=='1' %}selected{% endif
                                                    %}>Janvier</option>
                                                <option value="2" {% if request.args.get('mois_select')=='2' %}selected{% endif
                                                    %}>Février</option>
                                                <option value="3" {% if request.args.get('mois_select')=='3' %}selected{% endif
                                                    %}>Mars</option>
                                                <option value="4" {% if request.args.get('mois_select')=='4' %}selected{% endif
                                                    %}>Avril</option>
                                                <option value="5" {% if request.args.get('mois_select')=='5' %}selected{% endif
                                                    %}>Mai</option>
                                                <option value="6" {% if request.args.get('mois_select')=='6' %}selected{% endif
                                                    %}>Juin</option>
                                                <option value="7" {% if request.args.get('mois_select')=='7' %}selected{% endif
                                                    %}>Juillet</option>
                                                <option value="8" {% if request.args.get('mois_select')=='8' %}selected{% endif
                                                    %}>Août</option>
                                                <option value="9" {% if request.args.get('mois_select')=='9' %}selected{% endif
                                                    %}>Septembre</option>
                                                <option value="10" {% if request.args.get('mois_select')=='10' %}selected{%
                                                    endif %}>Octobre</option>
                                                <option value="11" {% if request.args.get('mois_select')=='11' %}selected{%
                                                    endif %}>Novembre</option>
                                                <option value="12" {% if request.args.get('mois_select')=='12' %}selected{%
                                                    endif %}>Décembre</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="annee_select" class="form-label">Année</label>
                                            <select class="form-select" id="annee_select" name="annee_select">
                                                <option value="">Sélectionner une année</option>
                                                {% set current_year = now.year if now else 2025 %}
                                                {% for year in range(current_year - 10, current_year + 2) %}
                                                <option value="{{ year }}" {% if request.args.get('annee_select')|int==year
                                                    %}selected{% endif %}>{{ year }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
        
                                <!-- Options pour période personnalisée -->
                                <div class="col-md-5 mb-3 {% if request.args.get('periode') != 'personnalisee' %}d-none{% endif %}"
                                    id="dateRangeContainer">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="date_debut" class="form-label">Date de début</label>
                                            <input type="date" class="form-control" id="date_debut" name="date_debut"
                                                value="{{ request.args.get('date_debut', '') }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="date_fin" class="form-label">Date de fin</label>
                                            <input type="date" class="form-control" id="date_fin" name="date_fin"
                                                value="{{ request.args.get('date_fin', '') }}">
                                        </div>
                                    </div>
                                </div>
        
                                <div class="col-md-4 d-flex align-items-end mb-3">
                                    <button type="submit" class="btn btn-primary me-2">Appliquer</button>
                                    <a href="{{ url_for('banking.banking_sous_compte_detail', compte_id=compte.id) }}"
                                        class="btn btn-outline-secondary">Réinitialiser</a>
                                </div>
                            </div>
        
                            <!-- Indications pour l'utilisateur -->
                            <div class="alert alert-info mt-3">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    Sélectionnez le type de période souhaitée et remplissez les champs correspondants.
                                    Les options s'afficheront automatiquement selon votre choix.
                                </small>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Historique des transactions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-exchange-alt me-2"></i>Historique des transactions</h5>
            </div>
            <div class="card-body p-0">
                {% if mouvements %}
                
                <div class="list-group list-group-flush">
                    {% for transaction in mouvements %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>
                                    {% if transaction.type_transaction == 'transfert_compte_vers_sous' %}
                                    + {{ "%.2f"|format(transaction.montant) }} {{ compte.devise }}
                                    {% elif transaction.type_transaction == 'transfert_sous_vers_compte' %}
                                    - {{ "%.2f"|format(transaction.montant) }} {{ compte.devise }}
                                    {% endif %}
                                </strong>
                                <div class="text-muted small">
                                    {{ transaction.date_transaction.strftime('%d/%m/%Y %H:%M') }} {% if transaction.solde_apres %} {{ transaction.solde_apres }} {% endif %}
                                    {% if transaction.commentaire %}
                                    <br>{{ transaction.commentaire }}
                                    {% endif %}
                                </div>
                            </div>
                            <div>
                                {% if transaction.type_transaction == 'transfert_compte_vers_sous' %}
                                <span class="badge bg-success">Alimentation</span>
                                {% elif transaction.type_transaction == 'transfert_sous_vers_compte' %}
                                <span class="badge bg-danger">Retrait</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-info-circle fa-2x text-muted mb-3"></i>
                    <p class="text-muted">Aucune transaction pour ce sous-compte</p>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Visualisation du solde — {{ soldes_quotidiens_len }} points</span>
                {% if sous_compte.pourcentage_objectif is defined and sous_compte.objectif_montant %}
                <span
                    class="badge bg-{{ 'success' if sous_compte.pourcentage_objectif >= 100 else 'warning' if sous_compte.pourcentage_objectif >= 75 else 'info' }} rounded-pill px-3 py-2">
                    {{ "%.1f"|format(sous_compte.pourcentage_objectif) }}% de l’objectif
                </span>
                {% endif %}
            </div>
            <div class="card-body">
                {% if graphique_svg %}
                <div class="text-center graphique-container">
                    <svg viewBox="0 0 {{ largeur_svg }} {{ hauteur_svg }}" preserveAspectRatio="xMidYMid meet"
                        class="graphique-svg"
                        style="border:1px solid #ddd; border-radius:8px; background:linear-gradient(to bottom, #f8f9fa, #ffffff); box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
        
                        <!-- Cadre du graphique -->
                        <rect x="{{ largeur_svg * 0.1 }}" y="{{ hauteur_svg * 0.1 }}" width="{{ largeur_svg * 0.8 }}"
                            height="{{ largeur_svg * 0.8 }}" fill="none" stroke="#ccc" stroke-dasharray="2,2" />
        
                        <!-- Ligne d'objectif (si définie) -->
                        {% if graphique_svg.objectif_y is not none %}
                        <line x1="{{ largeur_svg * 0.1 }}" y1="{{ graphique_svg.objectif_y }}" x2="{{ largeur_svg * 0.9 }}"
                            y2="{{ graphique_svg.objectif_y }}" stroke="{{ sous_compte.couleur }}" stroke-width="1" stroke-dasharray=",3" />
                        <text x="{{ largeur_svg * 0.82 }}-" y="{{ graphique_svg.objectif_y + 10 }}" font-size="9"
                            text-anchor="start" fill="{{ sous_compte.couleur }}" font-weight="bold">
                            Objectif: {{ "%.2f"|format(graphique_svg.objectif) }} CHF
                        </text>
                        {% endif %}
                        
                        <!-- Ligne horizontale milieu (subtile) -->
                        {% set mid_y = hauteur_svg * 0.1 + graphique_svg.plot_height / 2 %}
                        <line x1="{{ largeur_svg * 0.1 }}" y1="{{ mid_y }}" x2="{{ largeur_svg * 0.9 }}" y2="{{ mid_y }}"
                            stroke="#eee" stroke-width="1" stroke-dasharray="2,4" />
        
                        <!-- Ligne du graphique -->
                        <polyline points="{{ graphique_svg.points|join(' ') }}" fill="none" stroke="#007bff" stroke-width="2" />
        
                        <!-- Points -->
                        {% for point in graphique_svg.points %}
                        <circle cx="{{ point.split(',')[0] }}" cy="{{ point.split(',')[1] }}" r="3" fill="#007bff" />
                        {% endfor %}
        
                        <!-- Axe Y : min, mid, max -->
                        <text x="{{ largeur_svg * 0.08 }}" y="{{ hauteur_svg * 0.1 + 12 }}" font-size="9" text-anchor="end"
                            fill="#555">
                            {{ "%.2f"|format(graphique_svg.max_solde) }}
                        </text>
                        <text x="{{ largeur_svg * 0.08 }}" y="{{ mid_y + 4 }}" font-size="9" text-anchor="end" fill="#777">
                            {{ "%.2f"|format((graphique_svg.max_solde + graphique_svg.min_solde) / 2) }}
                        </text>
                        <text x="{{ largeur_svg * 0.08 }}" y="{{ hauteur_svg * 0.9 + 4 }}" font-size="9" text-anchor="end"
                            fill="#555">
                            {{ "%.2f"|format(graphique_svg.min_solde) }}
                        </text>
        
                        <!-- Axe X : dates -->
                        {% if graphique_svg.dates|length > 0 %}
                        <text x="{{ largeur_svg * 0.1 }}" y="{{ hauteur_svg * 0.9 + 20 }}" font-size="9" text-anchor="start"
                            fill="#555">
                            {{ graphique_svg.dates[0] }}
                        </text>
                        <text x="{{ largeur_svg * 0.9 }}" y="{{ hauteur_svg * 0.9 + 20 }}" font-size="9" text-anchor="end"
                            fill="#555">
                            {{ graphique_svg.dates[-1] }}
                        </text>
                        {% if graphique_svg.nb_points > 5 %}
                        <text x="{{ largeur_svg / 2 }}" y="{{ hauteur_svg * 0.9 + 20 }}" font-size="9" text-anchor="middle"
                            fill="#777">
                            {{ graphique_svg.dates[(graphique_svg.nb_points // 2)] }}
                        </text>
                        {% endif %}
                        {% endif %}
        
                        <!-- Légende -->
                        <text x="{{ largeur_svg / 2 }}" y="{{ hauteur_svg * 0.9 + 35 }}" font-size="10" text-anchor="middle"
                            fill="#333" font-weight="bold">
                            Date
                        </text>
                    </svg>
                </div>
        
                <!-- Tableau des données -->
                <div class="mt-4">
                    <h6 class="fw-bold border-bottom pb-2">Détails des soldes</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">Date</th>
                                    <th scope="col">Solde</th>
                                    <th scope="col">% de l’objectif</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for i in range(graphique_svg.dates|length) %}
                                <tr>
                                    <td>{{ graphique_svg.dates[i] }}</td>
                                    <td class="fw-medium">{{ "%.2f"|format(graphique_svg.soldes[i]) }} CHF</td>
                                    <td>
                                        {% if graphique_svg.objectif and graphique_svg.objectif > 0 %}
                                        <span
                                            class="badge bg-{{ 'success' if graphique_svg.soldes[i] >= graphique_svg.objectif else 'warning' if graphique_svg.soldes[i] >= graphique_svg.objectif * 0.75 else 'secondary' }} rounded-pill">
                                            {{ "%.1f"|format(graphique_svg.soldes[i] / graphique_svg.objectif * 100) }}%
                                        </span>
                                        {% else %}
                                        <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
        
                {% else %}
                <p class="text-muted text-center py-4">Aucune donnée disponible pour afficher l'évolution du solde.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<!-- Modal pour retrait -->
<div class="modal fade" id="modalRetraitSousCompte{{ sous_compte.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-arrow-left me-2"></i>Retirer du sous-compte</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('banking.banking_transfert') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Montant ({{ compte.devise }})</label>
                        <input type="number" name="montant" class="form-control" step="0.01" min="0.01"
                            max="{{ sous_compte.solde }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (optionnel)</label>
                        <input type="text" name="description" class="form-control"
                            placeholder="Ex: Retrait pour dépenses">
                    </div>
                    <input type="hidden" name="compte_id" value="{{ compte.id }}">
                    <input type="hidden" name="sous_compte_id" value="{{ sous_compte.id }}">
                    <input type="hidden" name="type_transfert" value="depuis_sous_compte">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane me-2"></i>Valider le
                        retrait</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal pour alimentation -->
<div class="modal fade" id="modalAlimentationSousCompte{{ sous_compte.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-arrow-right me-2"></i>Alimenter le sous-compte</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('banking.banking_transfert') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Montant ({{ compte.devise }})</label>
                        <input type="number" name="montant" class="form-control" step="0.01" min="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (optionnel)</label>
                        <input type="text" name="description" class="form-control" placeholder="Ex: Épargne mensuelle">
                    </div>
                    <input type="hidden" name="compte_id" value="{{ compte.id }}">
                    <input type="hidden" name="sous_compte_id" value="{{ sous_compte.id }}">
                    <input type="hidden" name="type_transfert" value="vers_sous_compte">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-paper-plane me-2"></i>Valider
                        l'alimentation</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Validation basique côté client
    (function () {
        'use strict';
        const forms = document.querySelectorAll('.needs-validation');

        Array.from(forms).forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    })();
</script>
<script>
    // Ajouter l'interactivité au survol des points
    document.addEventListener('DOMContentLoaded', function () {
        const points = document.querySelectorAll('.data-point');
        points.forEach(point => {
            point.addEventListener('mouseover', function () {
                this.style.transform = 'translate(-50%, 50%) scale(1.2)';
            });
            point.addEventListener('mouseout', function () {
                this.style.transform = 'translate(-50%, 50%)';
            });
        });
    });
</script>
{% endblock %}