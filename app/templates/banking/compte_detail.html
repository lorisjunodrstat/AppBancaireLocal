{% extends "base.html" %}

{% block extra_css %}
<style>
    .graphique-container {
        max-width: 600px;
        margin: 1rem auto;
    }

    .graphique-svg {
        width: 100%;
        height: auto;
        display: block;

        aspect-ratio: {
                {
                largeur_svg
            }
        }

        / {
                {
                hauteur_svg
            }
        }

        ;
        max-width: 100%;
        max-height: 70vh;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #f9f9f9;
    }
</style>
{% endblock %}

{% block title %}{{ compte.nom_compte }} - {{ compte.nom_banque }}{% endblock %}

{% block content %}

<div class="row" style="background-color: {{ compte.couleur_banque }};margin: top 10px">
    <div class="col-12">
        <!-- En-tête du compte -->
        <div class="card mb-4 border-top" style="border-top: 4px solid {{ compte.couleur_banque }};">
            <div class="card-body">
                <div class="row align-items-center">
                    <!-- Informations principales -->
                    <div class="col-md-8">
                        <div class="d-flex align-items-center mb-3">
                            <div class="rounded-circle d-inline-flex align-items-center justify-content-center me-3"
                                style="width: 50px; height: 50px; background-color: {{ compte.couleur_banque }};">
                                <i class="fas fa-university text-white fa-lg"></i>
                            </div>
                            <div>
                                <h2 class="mb-0">{{ compte.nom_compte }}</h2>
                                <h5>{{ compte.id }}</h5>
                                <p class="text-muted mb-0">{{ compte.nom_banque }} • {{ compte.type_compte|title }}</p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-6">
                                <small class="text-muted">Numéro de compte :</small>
                                <div><code>{{ compte.numero_compte }}</code></div>
                            </div>
                            {% if compte.iban %}
                            <div class="col-sm-6">
                                <small class="text-muted">IBAN :</small>
                                <div><code>{{ compte.iban }}</code></div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Solde et actions -->
                    <div class="col-md-4 text-end">
                        <div class="mb-2">
                            <small class="text-muted">Solde disponible</small>
                            <h3 class="mb-0">{{ "%.2f"|format(compte.solde) }} {{ compte.devise }}</h3>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Patrimoine total</small>
                            <h4 class="mb-0 text-success">{{ "%.2f"|format(solde_total) }} {{ compte.devise }}</h4>
                        </div>

                        <div class="btn-group">
                            <a href="{{ url_for('banking.banking_transfert') }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-exchange-alt me-1"></i>Transfert
                            </a>
                            <a href="{{ url_for('banking.banking_nouveau_sous_compte', compte_id=compte.id) }}"
                                class="btn btn-outline-success btn-sm">
                                <i class="fas fa-piggy-bank me-1"></i>Épargne
                            </a>
                        </div>
                        <div class="alert alert-warning" role="alert">
                            <h5><i class="bi bi-tools"></i> Outils de maintenance</h5>
                            <p>Si les soldes de votre compte semblent incohérents, vous pouvez forcer un recalcul complet.</p>
                            <form method="POST" action="{{ url_for('banking.reparer_soldes_compte', compte_id=compte.id) }}"
                                onsubmit='return confirm("Êtes-vous sûr de vouloir recalculer tous les soldes de ce compte ? Cette opération est sans risque mais peut prendre quelques secondes.");'>
                                <button type="submit" class="btn btn-danger">
                                    <i class="bi bi-arrow-clockwise"></i> Réparer les soldes
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Sous-comptes d'épargne -->
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-piggy-bank me-2"></i>Épargnes ({{ sous_comptes|length }})</h5>
                        <a href="{{ url_for('banking.banking_nouveau_sous_compte', compte_id=compte.id) }}"
                            class="btn btn-success btn-sm">
                            <i class="fas fa-plus me-1"></i>Nouvelle épargne
                        </a>
                    </div>
                    <div class="card-body">
                        {% if sous_comptes %}
                        {% for sc in sous_comptes %}

                        <div class="card mb-3 shadow-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-2 col-md-1 text-center">
                                        <i class="fas fa-{{ sc.icone }} fa-2x" style="color: {{ sc.couleur }};"></i>
                                    </div>
                                    <div class="col-10 col-md-4">
                                        <h6 class="mb-1">{{ sc.nom_sous_compte }}</h6>
                                        <p class="text-muted small mb-0">{{ sc.description or 'Aucune description' }}
                                        </p>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <h5 class="mb-0">{{ "%.2f"|format(sc.solde) }} {{ compte.devise }}</h5>
                                        <small class="text-muted">Solde</small>
                                    </div>
                                    <div class="col-md-3">
                                        {% if sc.objectif_montant and sc.objectif_montant > 0%}
                                        {% set pourcentage_objectif = (sc.solde / sc.objectif_montant) * 100 %}
                                        {% elif sc.objectif_montant is none %}
                                        {% set pourcentage_objectif = 0 %}
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between small">
                                                <span>{{ "%.0f"|format(sc.objectif_montant) }}</span>
                                                <span>{{ "%.1f"|format(pourcentage_objectif) }}%</span>
                                            </div>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar"
                                                    style="width: {{ pourcentage_objectif }}%; background-color: {{ sc.couleur }};">
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% if sc.date_objectif %}
                                        <small class="text-muted"><i class="fas fa-calendar me-1"></i>{{
                                            sc.date_objectif.strftime('%d/%m/%Y') }}</small>
                                        {% else %}
                                        <span class="badge bg-secondary">Épargne libre</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-1 text-end">
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle"
                                                data-bs-toggle="dropdown"></button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item"
                                                        href="{{ url_for('banking.banking_sous_compte_detail', sous_compte_id=sc.id) }}"><i
                                                            class="fas fa-eye me-2"></i>Détails</a></li>
                                                <li><a class="dropdown-item" href="#"
                                                        onclick="transfertRapide({{ compte.id }}, {{ sc.id }})"><i
                                                            class="fas fa-arrow-right me-2"></i>Alimenter</a></li>
                                                <li><a class="dropdown-item" href="#"
                                                        onclick="retraitRapide({{ compte.id }}, {{ sc.id }})"><i
                                                            class="fas fa-arrow-left me-2"></i>Retirer</a></li>
                                                <li>
                                                    <hr class="dropdown-divider">
                                                </li>
                                                <li><a class="dropdown-item text-danger"
                                                        href="{{ url_for('banking.banking_supprimer_sous_compte', sous_compte_id=sc.id) }}"
                                                        onclick="return confirm('Supprimer ce sous-compte ?')"><i
                                                            class="fas fa-trash me-2"></i>Supprimer</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-piggy-bank fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Aucune épargne configurée</h5>
                            <p class="text-muted">Créez votre première épargne pour commencer à mettre de l'argent de
                                côté.</p>
                            <a href="{{ url_for('banking.banking_nouveau_sous_compte', compte_id=compte.id) }}"
                                class="btn btn-success"><i class="fas fa-plus me-2"></i>Créer ma première épargne</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- Section filtre de la période-->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-calendar me-2"></i> Sélection de la période</h5>
                            <span class="badge bg-primary">{{ libelle_periode }}</span>
                        </div>
                        <div class="card-body">
                            <form method="GET" class="period-form">
                                <!-- Champs cachés pour conserver les autres paramètres -->
                                <input type="hidden" name="sort" value="{{ request.args.get('sort', 'date_desc') }}">
                                <input type="hidden" name="filter_type"
                                    value="{{ request.args.get('filter_type', 'tous') }}">
                                <input type="hidden" name="filter_min_amount"
                                    value="{{ request.args.get('filter_min_amount', '') }}">
                                <input type="hidden" name="filter_max_amount"
                                    value="{{ request.args.get('filter_max_amount', '') }}">
                                <input type="hidden" name="search" value="{{ request.args.get('search', '') }}">

                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label for="periode" class="form-label">Type de période</label>
                                        <select class="form-select" id="periode" name="periode">
                                            <option value="mois" {% if request.args.get('periode', 'mois' )=='mois'
                                                %}selected{% endif %}>Ce mois</option>
                                            <option value="trimestre" {% if request.args.get('periode')=='trimestre'
                                                %}selected{% endif %}>Ce trimestre</option>
                                            <option value="annee" {% if request.args.get('periode')=='annee'
                                                %}selected{% endif %}>
                                                Cette année</option>
                                            <option value="mois_annee" {% if request.args.get('periode')=='mois_annee'
                                                %}selected{% endif %}>Mois/Année spécifique</option>
                                            <option value="personnalisee" {% if
                                                request.args.get('periode')=='personnalisee' %}selected{% endif %}>
                                                Période personnalisée</option>
                                        </select>
                                    </div>

                                    <!-- Options pour mois/année spécifique -->
                                    <div class="col-md-5 mb-3 {% if request.args.get('periode') != 'mois_annee' %}d-none{% endif %}"
                                        id="moisAnneeContainer">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label for="mois_select" class="form-label">Mois</label>
                                                <select class="form-select" id="mois_select" name="mois_select">
                                                    <option value="">Sélectionner un mois</option>
                                                    <option value="1" {% if request.args.get('mois_select')=='1'
                                                        %}selected{% endif %}>Janvier</option>
                                                    <option value="2" {% if request.args.get('mois_select')=='2'
                                                        %}selected{% endif %}>Février</option>
                                                    <option value="3" {% if request.args.get('mois_select')=='3'
                                                        %}selected{% endif %}>Mars</option>
                                                    <option value="4" {% if request.args.get('mois_select')=='4'
                                                        %}selected{% endif %}>Avril</option>
                                                    <option value="5" {% if request.args.get('mois_select')=='5'
                                                        %}selected{% endif %}>Mai</option>
                                                    <option value="6" {% if request.args.get('mois_select')=='6'
                                                        %}selected{% endif %}>Juin</option>
                                                    <option value="7" {% if request.args.get('mois_select')=='7'
                                                        %}selected{% endif %}>Juillet</option>
                                                    <option value="8" {% if request.args.get('mois_select')=='8'
                                                        %}selected{% endif %}>Août</option>
                                                    <option value="9" {% if request.args.get('mois_select')=='9'
                                                        %}selected{% endif %}>Septembre</option>
                                                    <option value="10" {% if request.args.get('mois_select')=='10'
                                                        %}selected{% endif %}>Octobre</option>
                                                    <option value="11" {% if request.args.get('mois_select')=='11'
                                                        %}selected{% endif %}>Novembre</option>
                                                    <option value="12" {% if request.args.get('mois_select')=='12'
                                                        %}selected{% endif %}>Décembre</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="annee_select" class="form-label">Année</label>
                                                <select class="form-select" id="annee_select" name="annee_select">
                                                    <option value="">Sélectionner une année</option>
                                                    {% set current_year = now.year if now else 2025 %}
                                                    {% for year in range(current_year - 10, current_year + 2) %}
                                                    <option value="{{ year }}" {% if
                                                        request.args.get('annee_select')|int==year %}selected{% endif
                                                        %}>{{ year }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Options pour période personnalisée -->
                                    <div class="col-md-5 mb-3 {% if request.args.get('periode') != 'personnalisee' %}d-none{% endif %}"
                                        id="dateRangeContainer">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label for="date_debut" class="form-label">Date de début</label>
                                                <input type="date" class="form-control" id="date_debut"
                                                    name="date_debut" value="{{ request.args.get('date_debut', '') }}">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="date_fin" class="form-label">Date de fin</label>
                                                <input type="date" class="form-control" id="date_fin" name="date_fin"
                                                    value="{{ request.args.get('date_fin', '') }}">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4 d-flex align-items-end mb-3">
                                        <button type="submit" class="btn btn-primary me-2">Appliquer</button>
                                        <a href="{{ url_for('banking.banking_compte_detail', compte_id=compte.id) }}"
                                            class="btn btn-outline-secondary">Réinitialiser</a>
                                        <!-- Bouton pour compte AVEC période favorite -->
                                        {% if pf %}
                                        <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal"
                                            data-bs-target="#editPeriodeModal{{ pf.id }}">
                                            <i class="fas fa-gear me-1"></i> Modifier la période favorite
                                        </button>
                                        {% else %}
                                        <!-- Bouton pour compte SANS période favorite -->
                                        <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal"
                                            data-bs-target="#periode_favorite_modal_create">
                                            <i class="fas fa-gear me-1"></i> Créer la période favorite
                                        </button>
                                        {% endif %}
                                    </div>

                                    <!-- Indications pour l'utilisateur -->
                                    <div class="alert alert-info mt-3">
                                        <small>
                                            <i class="fas fa-info-circle me-1"></i>
                                            Sélectionnez le type de période souhaitée et remplissez les champs
                                            correspondants.
                                            Les options s'afficheront automatiquement selon votre choix.
                                        </small>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        <!-- Activité récente (Transactions + Transferts) -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Activité récente</h5>
                </div>
                <div class="card-body p-0">
                    {% if mouvements %}
                    <div class="list-group list-group-flush" id="listeMouvements">
                        <!-- Afficher les 5 premiers -->
                        {% for m in mouvements[:5] %}
                        <div class="list-group-item d-flex align-items-center">
                            <!-- Contenu identique à votre version -->
                            <div class="me-3">
                                {% if m.type_transaction in ['depot', 'retrait', 'transfert_vers_sous_compte',
                                'transfert_depuis_sous_compte'] %}
                                {% if m.type_transaction in ['depot', 'transfert_depuis_sous_compte', 'transfert_entrant'] %}
                                <i class="fas fa-plus-circle text-success"></i>
                                {% else %}
                                <i class="fas fa-minus-circle text-danger"></i>
                                {% endif %}
                                {% elif m.type_transaction in ['transfert_entrant', 'transfert_sortant', 'transfert_externe'] %}
                                {% if m.type_transaction == 'transfert_entrant' %}
                                <i class="fas fa-arrow-down text-success"></i>
                                {% elif m.type_transaction == 'transfert_sortant' %}
                                <i class="fas fa-arrow-up text-danger"></i>
                                {% else %}
                                <i class="fas fa-exchange-alt text-primary"></i>
                                {% endif %}
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between">
                                    <h6 class="mb-0">
                                        {% if m.type_transaction == 'depot' %}
                                        Dépôt
                                        {% elif m.type_transaction == 'retrait' %}
                                        Retrait
                                        {% elif m.type_transaction == 'transfert_vers_sous_compte' %}
                                        Vers {{ m.sous_compte_nom or 'Sous-compte' }}
                                        {% elif m.type_transaction == 'transfert_depuis_sous_compte' %}
                                        Depuis {{ m.sous_compte_nom or 'Sous-compte' }}
                                        {% elif m.type_transaction == 'transfert_entrant' %}
                                        <span class="text-success">Transfert reçu</span>
                                        {% elif m.type_transaction == 'transfert_sortant' %}
                                        <span class="text-danger">Transfert envoyé</span>
                                        {% elif m.type_transaction == 'transfert_externe' %}
                                        <span class="text-muted">Transfert externe</span>
                                        {% if m.statut and m.statut != 'completed' %}
                                        <span class="badge bg-warning ms-2">{{ m.statut|title }}</span>
                                        {% endif %}
                                        <small class="text-muted">(externe)</small>
                                        {% else %}
                                        {{ m.type_transaction|replace('_', ' ')|title }}
                                        {% endif %}
                                    </h6>
                                    <span
                                        class="{{ 'text-success' if m.montant > 0 else 'text-danger' if m.montant < 0 else 'text-muted' }}">
                                        {% if m.montant != 0 %}
                                        {{ '+' if m.montant > 0 else '' }}{{ "%.2f"|format(m.montant) }} {{ compte.devise }}
                                        {% else %}
                                        ⇄
                                        {% endif %}
                                    </span>
                                </div>
                                <small class="text-muted">
                                    {{ m.date_transaction.strftime('%d/%m/%Y %H:%M') }}
                                    {% if m.reference %} • {{ m.reference }}{% endif %}<br>
                                    {% if m.description %}{{ m.description|truncate(50) }}{% endif %}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
        
                        <!-- Les mouvements supplémentaires (6 à 20), cachés par défaut -->
                        {% for m in mouvements[5:20] %}
                        <div class="list-group-item d-flex align-items-center d-none" id="plusMouvements">
                            <!-- Même structure que ci-dessus -->
                            <div class="me-3">
                                {% if m.type_transaction in ['depot', 'retrait', 'transfert_vers_sous_compte',
                                'transfert_depuis_sous_compte'] %}
                                {% if m.type_transaction in ['depot', 'transfert_depuis_sous_compte', 'transfert_entrant'] %}
                                <i class="fas fa-plus-circle text-success"></i>
                                {% else %}
                                <i class="fas fa-minus-circle text-danger"></i>
                                {% endif %}
                                {% elif m.type_transaction in ['transfert_entrant', 'transfert_sortant', 'transfert_externe'] %}
                                {% if m.type_transaction == 'transfert_entrant' %}
                                <i class="fas fa-arrow-down text-success"></i>
                                {% elif m.type_transaction == 'transfert_sortant' %}
                                <i class="fas fa-arrow-up text-danger"></i>
                                {% else %}
                                <i class="fas fa-exchange-alt text-primary"></i>
                                {% endif %}
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between">
                                    <h6 class="mb-0">
                                        {% if m.type_transaction == 'depot' %}
                                        Dépôt
                                        {% elif m.type_transaction == 'retrait' %}
                                        Retrait
                                        {% elif m.type_transaction == 'transfert_vers_sous_compte' %}
                                        Vers {{ m.sous_compte_nom or 'Sous-compte' }}
                                        {% elif m.type_transaction == 'transfert_depuis_sous_compte' %}
                                        Depuis {{ m.sous_compte_nom or 'Sous-compte' }}
                                        {% elif m.type_transaction == 'transfert_entrant' %}
                                        <span class="text-success">Transfert reçu</span>
                                        {% elif m.type_transaction == 'transfert_sortant' %}
                                        <span class="text-danger">Transfert envoyé</span>
                                        {% elif m.type_transaction == 'transfert_externe' %}
                                        <span class="text-muted">Transfert externe</span>
                                        {% if m.statut and m.statut != 'completed' %}
                                        <span class="badge bg-warning ms-2">{{ m.statut|title }}</span>
                                        {% endif %}
                                        <small class="text-muted">(externe)</small>
                                        {% else %}
                                        {{ m.type_transaction|replace('_', ' ')|title }}
                                        {% endif %}
                                    </h6>
                                    <span
                                        class="{{ 'text-success' if m.montant > 0 else 'text-danger' if m.montant < 0 else 'text-muted' }}">
                                        {% if m.montant != 0 %}
                                        {{ '+' if m.montant > 0 else '' }}{{ "%.2f"|format(m.montant) }} {{ compte.devise }}
                                        {% else %}
                                        ⇄
                                        {% endif %}
                                    </span>
                                </div>
                                <small class="text-muted">
                                    {{ m.date_transaction.strftime('%d/%m/%Y %H:%M') }}
                                    {% if m.reference %} • {{ m.reference }}{% endif %}<br>
                                    {% if m.description %}{{ m.description|truncate(50) }}{% endif %}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
        
                    <!-- Bouton "Voir plus" si plus de 5 mouvements -->
                    {% if mouvements|length > 5 %}
                    <div class="card-footer text-center">
                        <button id="btnVoirPlus" class="btn btn-outline-primary btn-sm">
                            Voir les {{ mouvements[5:20]|length }} suivants
                        </button>
                    </div>
                    {% endif %}
        
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-history fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Aucune activité récente</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        </div>

        <!-- Graphiques -->
        <!-- Section Graphique : Répartition des soldes -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>Répartition des soldes
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartRepartition" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>


        <!-- Trésorerie -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Trésorerie - {{ libelle_periode }} </h5>

                        <!-- Sélecteur de période (sans JS) -->

                    </div>
                    <div class="card-body">
                        <!-- Graphique SVG en barres -->
                        <div class="mb-3">
                            <svg width="100%" height="200" class="chart-svg">
                                <!-- Barre des recettes -->
                                <g class="bar-group">
                                    <rect x="25%"
                                        y="{{ 200 - (total_recettes / (total_recettes + total_depenses) * 180 if (total_recettes + total_depenses) > 0 else 0) }}"
                                        width="20%"
                                        height="{{ (total_recettes / (total_recettes + total_depenses) * 180 if (total_recettes + total_depenses) > 0 else 0) }}"
                                        fill="#28a745" rx="2" ry="2" />
                                    <text x="35%" y="10" text-anchor="middle" font-size="12" fill="#28a745">
                                        {{ "%.2f"|format(total_recettes) }}
                                    </text>
                                    <text x="35%" y="195" text-anchor="middle" font-size="12" fill="#6c757d">
                                        Recettes
                                    </text>
                                </g>

                                <!-- Barre des dépenses -->
                                <g class="bar-group">
                                    <rect x="55%"
                                        y="{{ 15 +(200 - (total_depenses / (total_recettes + total_depenses) * 180) if (total_recettes + total_depenses) > 0 else 0) }}"
                                        width="20%"
                                        height="{{ ((total_depenses / (total_recettes + total_depenses) * 180) - 15 if (total_recettes + total_depenses) > 0 else 0) }}"
                                        fill="#dc3545" rx="2" ry="2" />
                                    <text x="65%" y="10" text-anchor="middle" font-size="12" fill="#dc3545">
                                        {{ "%.2f"|format(total_depenses) }}
                                    </text>
                                    <text x="65%" y="195" text-anchor="middle" font-size="12" fill="#6c757d">
                                        Dépenses
                                    </text>
                                </g>

                                <!-- Ligne de base -->
                                <line x1="20%" y1="180" x2="80%" y2="180" stroke="#dee2e6" stroke-width="2" />
                                <line x1="20%" y1="0" x2="80%" y2="0" stroke="#dee2e6" stroke-width="2" />
                                <line x1="20%" y1="0" x2="20%" y2="200" stroke="#dee2e6" stroke-width="1.5" />
                                < <line x1="80%" y1="0" x2="80%" y2="200" stroke="#dee2e6" stroke-width="1.5" />
                                < </svg>
                        </div>

                        <div class="mt-3">
                            <div class="d-flex justify-content-between">
                                <span class="text-success">
                                    <i class="fas fa-arrow-up me-1"></i>
                                    Total recettes: {{ "%.2f"|format(total_recettes) }} {{ compte.devise }}
                                </span>
                                <span class="text-danger">
                                    <i class="fas fa-arrow-down me-1"></i>
                                    Total dépenses: {{ "%.2f"|format(total_depenses) }} {{ compte.devise }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistiques des transferts -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Statistiques des transferts</h5>
                    </div>
                    <div class="card-body">
                        <!-- Filtrer les mouvements pour obtenir les transferts entrants et sortants -->
                        {% set transferts_entrants = mouvements|selectattr('type_transaction', 'equalto',
                        'transfert_entrant')|list %}
                        {% set transferts_sortants = mouvements|selectattr('type_transaction', 'equalto',
                        'transfert_sortant')|list %}

                        <div class="row text-center">
                            <div class="col-6">
                                <div class="bg-success bg-opacity-10 rounded p-3 mb-2">
                                    <i class="fas fa-arrow-down text-success fa-2x mb-2"></i>
                                    <h6 class="text-success mb-0">Reçus</h6>
                                    <small class="text-muted">{{ transferts_entrants|length }} transferts</small>
                                    <h5 class="text-success mb-0">
                                        {{ "%.2f"|format(transferts_entrants|sum(attribute='montant')|float) }} {{
                                        compte.devise }}
                                    </h5>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="bg-danger bg-opacity-10 rounded p-3 mb-2">
                                    <i class="fas fa-arrow-up text-danger fa-2x mb-2"></i>
                                    <h6 class="text-danger mb-0">Envoyés</h6>
                                    <small class="text-muted">{{ transferts_sortants|length }} transferts</small>
                                    <h5 class="text-danger mb-0">
                                        {{
                                        "%.2f"|format(transferts_sortants|map(attribute='montant')|map('abs')|sum|float)
                                        }} {{ compte.devise }}
                                    </h5>
                                </div>
                            </div>
                        </div>

                        <!-- Solde net des transferts -->
                        {% set solde_net_transferts = (transferts_entrants|sum(attribute='montant')|float) +
                        (transferts_sortants|sum(attribute='montant')|float) %}
                        <div
                            class="text-center mt-3 p-2 {{ 'bg-success' if solde_net_transferts >= 0 else 'bg-danger' }} bg-opacity-10 rounded">
                            <small class="text-muted">Solde net des transferts</small>
                            <h6 class="{{ 'text-success' if solde_net_transferts >= 0 else 'text-danger' }} mb-0">
                                {{ '+' if solde_net_transferts > 0 else '' }}{{ "%.2f"|format(solde_net_transferts) }}
                                {{ compte.devise }}
                            </h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--Liste des transactions et transferts-->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Liste des Mouvements [{{ mouvements|length }}]</h5>
                    </div>
                    <div class="card-body">
                        <nav class="navbar navbar-expand-lg bg-body-tertiary mb-3">
                            <div class="container-fluid">
                                <!-- Dropdown Trier par -->
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        Trier par
                                    </a>
                                    <ul class="dropdown-menu">
                                        {% set base_args = request.args.copy() %}
                                        {% for sort_val, label in [
                                        ('date_desc', 'Date (récent)'),
                                        ('date_asc', 'Date (ancien)'),
                                        ('montant_desc', 'Montant (↓)'),
                                        ('montant_asc', 'Montant (↑)')
                                        ] %}
                                        {% set args = base_args.copy() %}
                                        {% set _ = args.update({'sort': sort_val}) %}
                                        <li><a class="dropdown-item"
                                                href="{{ url_for('banking.banking_compte_detail', compte_id=compte.id, **args) }}">{{ label
                                                }}</a></li>
                                        {% endfor %}
                                    </ul>
                                </li>
                        
                                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown"
                                    aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                                    <span class="navbar-toggler-icon"></span>
                                </button>
                        
                                <div class="collapse navbar-collapse" id="navbarNavDropdown">
                                    <ul class="navbar-nav">
                                        <!-- Dropdown Filtre par Type -->
                                        <li class="nav-item dropdown">
                                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                                                aria-expanded="false">
                                                Filtre par Type
                                            </a>
                                            <ul class="dropdown-menu">
                                                {% set base_args = request.args.copy() %}
                                                {% for filter_val, label in [
                                                ('tous', 'Tous'),
                                                ('entree', 'Entrées'),
                                                ('sortie', 'Sorties'),
                                                ('transfert', 'Tous les transferts'),
                                                ('Transfert_Compte_Vers_Sous', '→ Vers sous-compte'),
                                                ('Transfert_Sous_Vers_Compte', '← Depuis sous-compte'),
                                                ('Transfert_intra_compte', '↔ Transferts internes')
                                                ] %}
                                                {% set args = base_args.copy() %}
                                                {% set _ = args.update({'filter_type': filter_val}) %}
                                                <li><a class="dropdown-item"
                                                        href="{{ url_for('banking.banking_compte_detail', compte_id=compte.id, **args) }}">{{
                                                        label }}</a></li>
                                                {% endfor %}
                                            </ul>
                                        </li>
                        
                                        <!-- Recherche -->
                                        <li class="nav-item ms-auto">
                                            <form class="d-flex" role="search"
                                                action="{{ url_for('banking.banking_compte_detail', compte_id=compte.id) }}" method="GET">
                                                <!-- Conserver tous les paramètres sauf "search" (qui sera remplacé) -->
                                                {% for key, value in request.args.items() %}
                                                {% if key != 'search' %}
                                                <input type="hidden" name="{{ key }}" value="{{ value }}">
                                                {% endif %}
                                                {% endfor %}
                                                <input class="form-control me-2" type="search" placeholder="Rechercher" aria-label="Search"
                                                    name="search" value="{{ request.args.get('search', '') }}">
                                                <button class="btn btn-outline-success" type="submit">Rechercher</button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </nav>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Source</th>
                                        <th>Destination</th>
                                        <th>Description</th>
                                        <th class="text-end">Montant</th>
                                        <th>Action</th>
                                        <th>Solde</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if mouvements %}
                                    {% for mv in mouvements %}
                                    <tr>
                                        <td>{{ mv.date_transaction.strftime('%d/%m/%Y %H:%M') }}</td>
                                        <td>
                                            <span
                                                class="badge bg-{{ 'success' if mv.montant > 0 else 'danger' if mv.montant < 0 else 'secondary' }}">
                                                {{ mv.type_transaction|replace('_', ' ')|title }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if mv.compte_source_nom %}
                                            {{ mv.compte_source_nom }}
                                            {% elif mv.sous_compte_source_nom %}
                                            {{ mv.sous_compte_source_nom }}
                                            {% elif mv.type_transaction == 'transfert_entrant' %}
                                            Compte externe
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if mv.compte_dest_nom %}
                                            {{ mv.compte_dest_nom }}
                                            {% elif mv.sous_compte_dest_nom %}
                                            {{ mv.sous_compte_dest_nom }}
                                            {% elif mv.type_transaction == 'transfert_sortant' %}
                                            Compte externe
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if mv.reference %}
                                            {{ mv.reference }}
                                            {% else %}
                                            {{ mv.description|default('', true) }}
                                            {% endif %}
                                        </td>
                                        <td
                                            class="text-end {{ 'text-success' if mv.montant > 0 else 'text-danger' if mv.montant < 0 else 'text-muted' }}">
                                            {{ '-' if mv.type_transaction in ['transfert_sortant',
                                            'transfert_compte_vers_sous', 'retrait',
                                            'recredit_annulation'] else '+' }}
                                            {{ "%.2f"|format(mv.montant) }} {{ compte.devise }}
                                        </td>
                                        <td class="text-end">
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                data-bs-toggle="modal" data-bs-target="#modalTransaction{{ mv.id }}">
                                                <i class="fas fa-edit"></i> Gérer
                                            </button>
                                        </td>
                                        <td>
                                            {% if mv.solde_apres %}
                                                {{ '%.2f'|format(mv.solde_apres) }} {% if compte.devise %}{{ compte.devise }}{% else %} CHF{% endif %}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% else %}
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">Aucun mouvement trouvé pour cette
                                            période.</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        {% if mouvements|length >= 20 %}
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" tabindex="-1">Précédent</a>
                                </li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item">
                                    <a class="page-link" href="#">Suivant</a>
                                </li>
                            </ul>
                        </nav>
                        {% endif %}

                    </div>
                </div>
            </div>
        </div>
        <!-- Graphique de l'évolution du solde -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Évolution du solde : {{ libelle_periode }}</h5>
            </div>
            <div class="card-body">
                {% if graphique_svg %}
                <div class="text-center graphique-container">
                    <svg viewBox="0 0 {{ largeur_svg }} {{ hauteur_svg }}" preserveAspectRatio="xMidYMid meet"
                        class="graphique-svg" style="border:1px solid #ddd; border-radius:5px; background:#f9f9f9;">

                        <!-- Cadre du graphique -->
                        <rect x="{{ largeur_svg * 0.1 }}" y="{{ hauteur_svg * 0.1 }}" width="{{ largeur_svg * 0.8 }}"
                            height="{{ hauteur_svg * 0.8 }}" fill="none" stroke="#ccc" stroke-dasharray="2,2" />

                        <!-- Lignes de grille horizontales (optionnelles, très subtiles) -->
                        {% set mid_y = hauteur_svg * 0.1 + graphique_svg.plot_height / 2 %}
                        <line x1="{{ largeur_svg * 0.1 }}" y1="{{ mid_y }}" x2="{{ largeur_svg * 0.9 }}"
                            y2="{{ mid_y }}" stroke="#eee" stroke-width="1" stroke-dasharray="2,4" />

                        <!-- Ligne du graphique -->
                        <polyline points="{{ graphique_svg.points|join(' ') }}" fill="none"
                            stroke="{{ compte.couleur_banque }}" stroke-width="2" />

                        <!-- Points sur la ligne -->
                        {% for point in graphique_svg.points %}
                        <circle cx="{{ point.split(',')[0] }}" cy="{{ point.split(',')[1] }}" r="3" fill="#007bff" />
                        {% endfor %}

                        <!-- Étiquettes sur l'axe Y (gauche) -->
                        <!-- Max -->
                        <text x="{{ largeur_svg * 0.08 }}" y="{{ hauteur_svg * 0.1 + 12 }}" font-size="9"
                            text-anchor="end" fill="#555">
                            {{ graphique_svg.max_solde|round(2) }} CHF
                        </text>
                        <!-- Milieu -->
                        <text x="{{ largeur_svg * 0.08 }}" y="{{ mid_y + 4 }}" font-size="9" text-anchor="end"
                            fill="#777">
                            {{ ((graphique_svg.max_solde + graphique_svg.min_solde) / 2)|round(2) }}
                        </text>
                        <!-- Min -->
                        <text x="{{ largeur_svg * 0.08 }}" y="{{ hauteur_svg * 0.9 + 4 }}" font-size="10"
                            text-anchor="end" fill="#555">
                            {{ graphique_svg.min_solde|round(2) }}
                        </text>

                        <!-- Étiquettes sur l'axe X (bas) -->
                        {% if graphique_svg.dates|length > 0 %}
                        <!-- Début -->
                        <text x="{{ largeur_svg * 0.1 }}" y="{{ hauteur_svg * 0.9 + 20 }}" font-size="10"
                            text-anchor="start" fill="#555">
                            {{ graphique_svg.dates[0] }}
                        </text>
                        <!-- Fin -->
                        <text x="{{ largeur_svg * 0.9 }}" y="{{ hauteur_svg * 0.9 + 20 }}" font-size="10"
                            text-anchor="end" fill="#555">
                            {{ graphique_svg.dates[-1] }}
                        </text>
                        <!-- Milieu (seulement si assez de points pour éviter chevauchement) -->
                        {% if graphique_svg.nb_points > 5 %}
                        <text x="{{ largeur_svg / 2 }}" y="{{ hauteur_svg * 0.9 + 20 }}" font-size="9"
                            text-anchor="middle" fill="#777">
                            {{ graphique_svg.dates[(graphique_svg.nb_points // 2)] }}
                        </text>
                        {% endif %}
                        {% endif %}

                        <!-- Légende axe X -->
                        <text x="{{ largeur_svg / 2 }}" y="{{ hauteur_svg * 0.9 + 35 }}" font-size="11"
                            text-anchor="middle" fill="#333" font-weight="bold">
                            Date
                        </text>

                    </svg>
                </div>

                <!-- Tableau des valeurs -->
                <div class="mt-3">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Solde</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for i in range(graphique_svg.dates|length) %}
                                <tr>
                                    <td>{{ graphique_svg.dates[i] }}</td>
                                    <td>{{ graphique_svg.soldes[i]|round(2) }} {{ compte.devise }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <p class="text-muted">Aucune donnée disponible pour afficher l'évolution du solde.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Inclusion des modals de transaction -->
{% if mouvements %}
{% for mv in mouvements %}
{% include "banking/transaction_modal.html" %}
{% endfor %}
{% endif %}


<!-- ✅ Modals pour périodes favorites : à déplacer ici -->
{% if pf %}
  {% include "banking/periode_favorite_modal.html" %}
{% else %}
  {% include "banking/periode_favorite_modal_create.html" %}
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    // Scripts pour initialiser les graphiques Chart.js
    document.addEventListener('DOMContentLoaded', function () {
        // Graphique de répartition des soldes
        var ctxRepartition = document.getElementById('chartRepartition').getContext('2d');
        var chartRepartition = new Chart(ctxRepartition, {
            type: 'pie',
            data: {
                labels: ['Solde principal', 'Épargnes'],
                datasets: [{
                    data: [{{ compte.solde }}, {{ solde_total - compte.solde }}],
                    backgroundColor: [
                        '{{ compte.couleur_banque }}',
                        '#28a745'
                    ]
                }]
            },
        options: {
        responsive: true,
        maintainAspectRatio: false
    }
        });

    // Graphique de trésorerie
    var ctxTresorerie = document.getElementById('chartTresorerie').getContext('2d');
    var chartTresorerie = new Chart(ctxTresorerie, {
        type: 'bar',
        data: {
            labels: ['Recettes', 'Dépenses'],
            datasets: [{
                label: 'Montant',
                data: [{{ total_recettes }}, {{ total_depenses }}],
        backgroundColor: [
            'rgba(40, 167, 69, 0.7)',
            'rgba(220, 53, 69, 0.7)'
        ],
        borderColor: [
            'rgba(40, 167, 69, 1)',
            'rgba(220, 53, 69, 1)'
        ],
        borderWidth: 1
    }]
        },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                scales: {
            y: {
                beginAtZero: true
            }
        }
    }
    });
    });

    // Fonctions pour les transferts rapides
    function transfertRapide(compteId, sousCompteId) {
        // Implémentation de la fonction de transfert rapide
        console.log("Transfert rapide depuis le compte " + compteId + " vers le sous-compte " + sousCompteId);
        // Redirection vers le formulaire de transfert avec pré-remplissage
        window.location.href = "{{ url_for('banking.banking_transfert') }}?source=" + compteId + "&destination_type=sous_compte&destination=" + sousCompteId;
    }

    function retraitRapide(compteId, sousCompteId) {
        // Implémentation de la fonction de retrait rapide
        console.log("Retrait rapide depuis le sous-compte " + sousCompteId + " vers le compte " + compteId);
        // Redirection vers le formulaire de transfert avec pré-remplissage
        window.location.href = "{{ url_for('banking.banking_transfert') }}?source_type=sous_compte&source=" + sousCompteId + "&destination=" + compteId;
    }
</script>
{% endblock %}