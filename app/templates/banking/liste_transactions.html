{% extends "base.html" %}

{% block title %}Transactions et transferts{% endblock %}
{% block content %}
<h2>Transactions / Transferts</h2>


<form method="get" action="{{ url_for('banking.liste_transferts') }}" class="mb-3">
  <div class="row gy-2 gx-2 align-items-end">
    <div class="col-auto"><label>Date de :</label>
      <input type="date" name="date_from" value="{{ date_from or '' }}">
    </div>
    <div class="col-auto"><label>À :</label>
      <input type="date" name="date_to" value="{{ date_to or '' }}">
    </div>

    <div class="col-auto"><label>Compte origine :</label>
      <select name="compte_id">
        <option value="">Tous</option>
        {% for c in comptes %}
        <option value="{{ c.id }}" {% if compte_source_filter|int==c.id %}selected{% endif %}>
          {{ c.nom_compte }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto"><label>Compte destination :</label>
      <select name="compte_dest_id">
        <option value="">Tous</option>
        {% for c in comptes %}
        <option value="{{ c.id }}" {% if compte_dest_filter|int==c.id %}selected{% endif %}>
          {{ c.nom_compte }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto"><label>Sous‑compte origine :</label>
      <select name="sous_compte_id">
        <option value="">Tous</option>
        {% for sc in sous_comptes %}
        <option value="{{ sc.id }}" {% if sc_filter|int==sc.id %}selected{% endif %}>
          {{ sc.nom_sous_compte }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto"><label>Sous‑compte destination :</label>
      <select name="sous_compte_dest_id">x
        <option value="">Tous</option>
        {% for sc in sous_comptes %}
        <option value="{{ sc.id }}" {% if dest_sc_filter|int==sc.id %}selected{% endif %}>
          {{ sc.nom_sous_compte }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto"><label>Référence :</label>
      <select name="reference">
        <option value="">Toutes</option>
        {% set refs = transactions|map(attribute='reference')|unique|list %}
        {% for r in refs if r %}
        <option value="{{ r }}" {% if ref_filter==r %}selected{% endif %}>{{ r }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto"><label>Recherche texte :</label>
      <input type="text" name="text_search" placeholder="mot-clé" value="{{ text_search or '' }}">
    </div>

    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Filtrer</button>
    </div>
  </div>
</form>

<a href="{{ url_for('banking.liste_transferts',
    date_from=date_from, date_to=date_to,
    compte_id=compte_source_filter, compte_dest_id=compte_dest_filter,
    sous_compte_id=sc_filter, sous_compte_destination_id=dest_sc_filter,
    reference=ref_filter, q=text_search,
    page=page, export='csv') }}" class="btn btn-outline-secondary mb-3">Exporter CSV ancien</a>


<div class="d-flex justify-content-between mb-3">
  <a href="{{ url_for('banking.liste_transferts',
        date_from=date_from, date_to=date_to,
        compte_id=compte_source_filter, sous_compte_id=sc_filter,
        sous_compte_destination_id=dest_sc_filter,
        reference=ref_filter, q=text_search,
        page=page, export='csv') }}" class="btn btn-outline-secondary">Exporter en CSV</a>

  <!-- Bouton pour créer une nouvelle transaction -->
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editTransactionModal">
    Créer une transaction
  </button>
</div>

<table class="table table-striped">
  <thead>
    <tr>
      <th>Date</th>
      <th>Type</th>
      <th>Description</th>
      <th>Montant</th>
      <th>Compte / Sous‑compte</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for t in transactions %}
    <tr>
      <td>{{ t.date_transaction.strftime('%d/%m/%Y %H:%M') }}</td>
      <td>{{ t.type_transaction.replace('_',' ').capitalize() }}</td>
      <td>{{ t.description or '-' }}</td>
      <td
        class="{{ 'text-success' if t.type_transaction in ['depot','transfert_depuis_sous_compte'] else 'text-danger' }}">
        {{ ('+' if t.type_transaction in ['depot','transfert_depuis_sous_compte'] else '-') }}{{
        "%.2f"|format(t.montant) }} CHF
      </td>
      <td>
        {% if t.type_transaction=='transfert_vers_sous_compte' %}
        Vers {{ t.nom_sous_compte_destination }}
        {% elif t.type_transaction=='transfert_depuis_sous_compte' %}
        Depuis {{ t.nom_sous_compte }}
        {% else %}
        Compte principal
        {% endif %}
      </td>
      <td>
        <a href="{{ url_for('banking.modifier_transfert', transfert_id=t.id) }}" class="btn btn-sm btn-outline-primary">
          Éditer
        </a>
        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
          data-bs-target="#modalTransaction{{ t.id }}">
          <i class="fas fa-edit"></i> Gérer
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<!-- Inclusion des modals de transaction -->
{% if transactions %}
{% for mtv in transactions %}
{% include "banking/transaction_modal.html" %}
{% endfor %}
{% endif %}

{% if pages > 1 %}
<nav aria-label="Pagination" class="mt-3">
  <ul class="pagination">
    {% if page > 1 %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('banking.liste_transferts',
               date_from=date_from, date_to=date_to,
               sort_by=sort_by, order=order,
               page=page-1,
               compte_id=compte_source_filter, compte_dest_id=compte_dest_filter,
               sous_compte_id=sc_filter,
               sous_compte_destination_id=dest_sc_filter,
               reference=ref_filter, q=text_search) }}">« Précédent</a>
    </li>
    {% endif %}

    <li class="page-item disabled">
      <span class="page-link">Page {{ page }} / {{ pages }}</span>
    </li>

    {% if page < pages %} <li class="page-item">
      <a class="page-link" href="{{ url_for('banking.liste_transferts',
               date_from=date_from, date_to=date_to,
               sort_by=sort_by, order=order,
               page=page+1,
               compte_id=compte_source_filter, compte_dest_id=compte_dest_filter,
               sous_compte_id=sc_filter,
               sous_compte_destination_id=dest_sc_filter,
               reference=ref_filter, q=text_search) }}">Suivant »</a>
      </li>
      {% endif %}
  </ul>
</nav>
{% endif %}


{% endblock %}