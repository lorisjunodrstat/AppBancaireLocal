{% extends "base.html" %}

{% block title %}Transactions et transferts{% endblock %}
{% block content %}
<h2>Transactions / Transferts</h2>


<form method="get" action="{{ url_for('banking.liste_transferts') }}" class="mb-3">
  <div class="row gy-2 gx-2 align-items-end">
    <div class="col-auto"><label>Date de :</label>
      <input type="date" name="date_from" value="{{ date_from or '' }}">
    </div>
    <div class="col-auto"><label>À :</label>
      <input type="date" name="date_to" value="{{ date_to or '' }}">
    </div>

    <div class="col-auto"><label>Compte origine :</label>
      <select name="compte_id">
        <option value="">Tous</option>
        {% for c in comptes %}
        <option value="{{ c.id }}" {% if compte_filter|int==c.id %}selected{% endif %}>
          {{ c.nom_compte }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto"><label>Compte destination :</label>
      <select name="compte_dest_id">
        <option value="">Tous</option>
        {% for c in comptes %}
        <option value="{{ c.id }}" {% if compte_dest_filter|int==c.id %}selected{% endif %}>
          {{ c.nom_compte }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto"><label>Sous‑compte origine :</label>
      <select name="sous_compte_id">
        <option value="">Tous</option>
        {% for sc in sous_comptes %}
        <option value="{{ sc.id }}" {% if sc_filter|int==sc.id %}selected{% endif %}>
          {{ sc.nom_sous_compte }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto"><label>Sous‑compte destination :</label>
      <select name="sous_compte_destination_id">
        <option value="">Tous</option>
        {% for sc in sous_comptes %}
        <option value="{{ sc.id }}" {% if dest_sc_filter|int==sc.id %}selected{% endif %}>
          {{ sc.nom_sous_compte }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto"><label>Référence :</label>
      <select name="reference">
        <option value="">Toutes</option>
        {% set refs = transactions|map(attribute='reference')|unique|list %}
        {% for r in refs if r %}
        <option value="{{ r }}" {% if ref_filter==r %}selected{% endif %}>{{ r }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto"><label>Recherche texte :</label>
      <input type="text" name="q" placeholder="mot-clé" value="{{ text_search or '' }}">
    </div>

    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Filtrer</button>
    </div>
  </div>
</form>

<a href="{{ url_for('banking.liste_transferts',
    date_from=date_from, date_to=date_to,
    compte_id=compte_filter, compte_dest_id=compte_dest_filter,
    sous_compte_id=sc_filter, sous_compte_destination_id=dest_sc_filter,
    reference=ref_filter, q=text_search,
    page=page, export='csv') }}" class="btn btn-outline-secondary mb-3">Exporter CSV ancien</a>


<div class="d-flex justify-content-between mb-3">
  <a href="{{ url_for('banking.liste_transferts',
        date_from=date_from, date_to=date_to,
        compte_id=compte_filter, sous_compte_id=sc_filter,
        sous_compte_destination_id=dest_sc_filter,
        reference=ref_filter, q=text_search,
        page=page, export='csv') }}" class="btn btn-outline-secondary">Exporter en CSV</a>

  <!-- Bouton pour créer une nouvelle transaction -->
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editTransactionModal">
    Créer une transaction
  </button>
</div>

<table class="table table-striped">
  <thead>
    <tr>
      <th>Date</th>
      <th>Type</th>
      <th>Description</th>
      <th>Montant</th>
      <th>Compte / Sous‑compte</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for t in transactions %}
    <tr>
      <td>{{ t.date_transaction.strftime('%d/%m/%Y %H:%M') }}</td>
      <td>{{ t.type_transaction.replace('_',' ').capitalize() }}</td>
      <td>{{ t.description or '-' }}</td>
      <td
        class="{{ 'text-success' if t.type_transaction in ['depot','transfert_depuis_sous_compte'] else 'text-danger' }}">
        {{ ('+' if t.type_transaction in ['depot','transfert_depuis_sous_compte'] else '-') }}{{
        "%.2f"|format(t.montant) }} CHF
      </td>
      <td>
        {% if t.type_transaction=='transfert_vers_sous_compte' %}
        Vers {{ t.nom_sous_compte_destination }}
        {% elif t.type_transaction=='transfert_depuis_sous_compte' %}
        Depuis {{ t.nom_sous_compte }}
        {% else %}
        Compte principal
        {% endif %}
      </td>
      <td>
        <button class="btn btn-sm btn-outline-primary edit-btn" data-id="{{ t.id }}"
          data-type="{{ t.type_transaction }}" data-montant="{{ t.montant }}"
          data-description="{{ t.description or '' }}" data-reference="{{ t.reference or '' }}"
          data-compte-id="{{ t.compte_principal_id }}" data-sous-compte-id="{{ t.sous_compte_id or '' }}"
          data-sous-compte-dest-id="{{ t.sous_compte_destination_id or '' }}"
          data-compte-dest-id="{{ t.compte_destination_id or '' }}">
          Éditer
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Modal pour éditer/créer une transaction -->
<div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editTransactionModalLabel">Éditer Transaction</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="transactionForm" method="post" action="{{ url_for('banking.edit_transaction') }}">
        <div class="modal-body">
          <input type="hidden" name="transaction_id" id="transactionId">

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="typeTransaction" class="form-label">Type de transaction</label>
              <select class="form-select" id="typeTransaction" name="type_transaction" required>
                <option value="depot">Dépôt</option>
                <option value="retrait">Retrait</option>
                <option value="transfert_vers_sous_compte">Transfert vers sous-compte</option>
                <option value="transfert_depuis_sous_compte">Transfert depuis sous-compte</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="montant" class="form-label">Montant (CHF)</label>
              <input type="number" step="0.01" class="form-control" id="montant" name="montant" required>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="compteId" class="form-label">Compte source</label>
              <select class="form-select" id="compteId" name="compte_id">
                <option value="">Sélectionner...</option>
                {% for c in comptes %}
                <option value="{{ c.id }}">{{ c.nom_compte }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label for="sousCompteId" class="form-label">Sous-compte source</label>
              <select class="form-select" id="sousCompteId" name="sous_compte_id">
                <option value="">Sélectionner...</option>
                {% for sc in sous_comptes %}
                <option value="{{ sc.id }}" data-compte-id="{{ sc.compte_principal_id }}">{{ sc.nom_sous_compte }}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="row mb-3" id="destinationFields">
            <div class="col-md-6">
              <label for="compteDestId" class="form-label">Compte destination</label>
              <select class="form-select" id="compteDestId" name="compte_dest_id">
                <option value="">Sélectionner...</option>
                {% for c in comptes %}
                <option value="{{ c.id }}">{{ c.nom_compte }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label for="sousCompteDestId" class="form-label">Sous-compte destination</label>
              <select class="form-select" id="sousCompteDestId" name="sous_compte_dest_id">
                <option value="">Sélectionner...</option>
                {% for sc in sous_comptes %}
                <option value="{{ sc.id }}" data-compte-id="{{ sc.compte_principal_id }}">{{ sc.nom_sous_compte }}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" rows="2"></textarea>
          </div>

          <div class="mb-3">
            <label for="reference" class="form-label">Référence</label>
            <input type="text" class="form-control" id="reference" name="reference">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% if pages > 1 %}
<nav aria-label="Pagination" class="mt-3">
  <ul class="pagination">
    {% if page > 1 %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('banking.liste_transferts',
               date_from=date_from, date_to=date_to,
               sort_by=sort_by, order=order,
               page=page-1,
               compte_id=compte_filter, compte_dest_id=compte_dest_filter,
               sous_compte_id=sc_filter,
               sous_compte_destination_id=dest_sc_filter,
               reference=ref_filter, q=text_search) }}">« Précédent</a>
    </li>
    {% endif %}

    <li class="page-item disabled">
      <span class="page-link">Page {{ page }} / {{ pages }}</span>
    </li>

    {% if page < pages %} <li class="page-item">
      <a class="page-link" href="{{ url_for('banking.liste_transferts',
               date_from=date_from, date_to=date_to,
               sort_by=sort_by, order=order,
               page=page+1,
               compte_id=compte_filter, compte_dest_id=compte_dest_filter,
               sous_compte_id=sc_filter,
               sous_compte_destination_id=dest_sc_filter,
               reference=ref_filter, q=text_search) }}">Suivant »</a>
      </li>
      {% endif %}
  </ul>
</nav>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Gestion de l'affichage des champs en fonction du type de transaction
    const typeSelect = document.getElementById('typeTransaction');
    const compteIdSelect = document.getElementById('compteId');
    const sousCompteIdSelect = document.getElementById('sousCompteId');
    const destinationFields = document.getElementById('destinationFields');

    function updateFieldsVisibility() {
      const type = typeSelect.value;

      if (type === 'transfert_vers_sous_compte') {
        destinationFields.style.display = 'flex';
        sousCompteIdSelect.disabled = true;
      } else if (type === 'transfert_depuis_sous_compte') {
        destinationFields.style.display = 'flex';
        sousCompteIdSelect.disabled = false;
      } else {
        destinationFields.style.display = 'none';
        sousCompteIdSelect.disabled = false;
      }
    }

    typeSelect.addEventListener('change', updateFieldsVisibility);
    updateFieldsVisibility();

    // Filtrage des sous-comptes en fonction du compte sélectionné
    compteIdSelect.addEventListener('change', function () {
      const compteId = this.value;
      const options = sousCompteIdSelect.querySelectorAll('option');

      options.forEach(option => {
        if (option.value === "") {
          option.style.display = 'block';
        } else {
          const optionCompteId = option.getAttribute('data-compte-id');
          option.style.display = optionCompteId === compteId ? 'block' : 'none';
        }
      });

      sousCompteIdSelect.value = "";
    });

    // Gestion des boutons d'édition
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        const modal = new bootstrap.Modal(document.getElementById('editTransactionModal'));
        const form = document.getElementById('transactionForm');

        // Remplir le formulaire avec les données de la transaction
        document.getElementById('transactionId').value = this.dataset.id;
        document.getElementById('typeTransaction').value = this.dataset.type;
        document.getElementById('montant').value = this.dataset.montant;
        document.getElementById('description').value = this.dataset.description;
        document.getElementById('reference').value = this.dataset.reference;
        document.getElementById('compteId').value = this.dataset.compteId;

        if (this.dataset.sousCompteId) {
          document.getElementById('sousCompteId').value = this.dataset.sousCompteId;
        }

        if (this.dataset.compteDestId) {
          document.getElementById('compteDestId').value = this.dataset.compteDestId;
        }

        if (this.dataset.sousCompteDestId) {
          document.getElementById('sousCompteDestId').value = this.dataset.sousCompteDestId;
        }

        // Mettre à jour la visibilité des champs
        updateFieldsVisibility();

        // Afficher le modal
        modal.show();
      });
    });

    // Nouvelle transaction - réinitialiser le formulaire
    document.getElementById('editTransactionModal').addEventListener('show.bs.modal', function (event) {
      if (!event.relatedTarget) {
        document.getElementById('transactionForm').reset();
        document.getElementById('transactionId').value = '';
        updateFieldsVisibility();
      }
    });
  });
</script>

{% endblock %}