{% extends "base.html" %}

{% block title %}{{ compte.nom_compte }} - {{ compte.nom_banque }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- En-tête du compte -->
        <div class="card mb-4 border-top" style="border-top: 4px solid {{ compte.couleur_banque }};">
            <div class="card-body">
                <div class="row align-items-center">
                    <!-- Informations principales -->
                    <div class="col-md-8">
                        <div class="d-flex align-items-center mb-3">
                            <div class="rounded-circle d-inline-flex align-items-center justify-content-center me-3"
                                style="width: 50px; height: 50px; background-color: {{ compte.couleur_banque }};">
                                <i class="fas fa-university text-white fa-lg"></i>
                            </div>
                            <div>
                                <h2 class="mb-0">{{ compte.nom_compte }}</h2>
                                <p class="text-muted mb-0">{{ compte.nom_banque }} • {{ compte.type_compte|title }}</p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-6">
                                <small class="text-muted">Numéro de compte :</small>
                                <div><code>{{ compte.numero_compte }}</code></div>
                            </div>
                            {% if compte.iban %}
                            <div class="col-sm-6">
                                <small class="text-muted">IBAN :</small>
                                <div><code>{{ compte.iban }}</code></div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Solde et actions -->
                    <div class="col-md-4 text-end">
                        <div class="mb-2">
                            <small class="text-muted">Solde disponible</small>
                            <h3 class="mb-0">{{ "%.2f"|format(compte.solde) }} {{ compte.devise }}</h3>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Patrimoine total</small>
                            <h4 class="mb-0 text-success">{{ "%.2f"|format(solde_total) }} {{ compte.devise }}</h4>
                        </div>

                        <div class="btn-group">
                            <a href="{{ url_for('banking_transfert') }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-exchange-alt me-1"></i>Transfert
                            </a>
                            <a href="{{ url_for('banking_transaction') }}" class="btn btn-success btn-sm">
                                <i class="fas fa-plus me-1"></i>Dépôt
                            </a>
                            <a href="{{ url_for('banking_nouveau_sous_compte', compte_id=compte.id) }}"
                                class="btn btn-outline-success btn-sm">
                                <i class="fas fa-piggy-bank me-1"></i>Épargne
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Sous-comptes d'épargne -->
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-piggy-bank me-2"></i>Épargnes ({{ sous_comptes|length }})</h5>
                        <a href="{{ url_for('banking_nouveau_sous_compte', compte_id=compte.id) }}"
                            class="btn btn-success btn-sm">
                            <i class="fas fa-plus me-1"></i>Nouvelle épargne
                        </a>
                    </div>
                    <div class="card-body">
                        {% if sous_comptes %}
                        {% for sc in sous_comptes %}
                        <div class="card mb-3 shadow-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-2 col-md-1 text-center">
                                        <i class="fas fa-{{ sc.icone }} fa-2x" style="color: {{ sc.couleur }};"></i>
                                    </div>
                                    <div class="col-10 col-md-4">
                                        <h6 class="mb-1">{{ sc.nom_sous_compte }}</h6>
                                        <p class="text-muted small mb-0">{{ sc.description or 'Aucune description' }}
                                        </p>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <h5 class="mb-0">{{ "%.2f"|format(sc.solde) }} {{ compte.devise }}</h5>
                                        <small class="text-muted">Solde</small>
                                    </div>
                                    <div class="col-md-3">
                                        {% if sc.objectif_montant %}
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between small">
                                                <span>{{ "%.0f"|format(sc.objectif_montant) }} {{ compte.devise
                                                    }}</span>
                                                <span>{{ "%.1f"|format(sc.pourcentage_objectif) }}%</span>
                                            </div>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar"
                                                    style="width: {{ sc.pourcentage_objectif }}%; background-color: {{ sc.couleur }};">
                                                </div>
                                            </div>
                                        </div>
                                        {% if sc.date_objectif %}
                                        <small class="text-muted"><i class="fas fa-calendar me-1"></i>{{
                                            sc.date_objectif.strftime('%d/%m/%Y') }}</small>
                                        {% endif %}
                                        {% else %}
                                        <span class="badge bg-secondary">Épargne libre</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-1 text-end">
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle"
                                                data-bs-toggle="dropdown"></button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item"
                                                        href="{{ url_for('banking_sous_compte_detail', sous_compte_id=sc.id) }}"><i
                                                            class="fas fa-eye me-2"></i>Détails</a></li>
                                                <li><a class="dropdown-item" href="#"
                                                        onclick="transfertRapide({{ compte.id }}, {{ sc.id }})"><i
                                                            class="fas fa-arrow-right me-2"></i>Alimenter</a></li>
                                                <li><a class="dropdown-item" href="#"
                                                        onclick="retraitRapide({{ compte.id }}, {{ sc.id }})"><i
                                                            class="fas fa-arrow-left me-2"></i>Retirer</a></li>
                                                <li>
                                                    <hr class="dropdown-divider">
                                                </li>
                                                <li><a class="dropdown-item text-danger"
                                                        href="{{ url_for('banking_supprimer_sous_compte', sous_compte_id=sc.id) }}"
                                                        onclick="return confirm('Supprimer ce sous-compte ?')"><i
                                                            class="fas fa-trash me-2"></i>Supprimer</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-piggy-bank fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Aucune épargne configurée</h5>
                            <p class="text-muted">Créez votre première épargne pour commencer à mettre de l'argent de
                                côté.</p>
                            <a href="{{ url_for('banking_nouveau_sous_compte', compte_id=compte.id) }}"
                                class="btn btn-success"><i class="fas fa-plus me-2"></i>Créer ma première épargne</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Activité récente (Transactions + Transferts) -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Activité récente</h5>
                    </div>
                    <div class="card-body p-0">
                        {% if mouvements %}
                        <div class="list-group list-group-flush">
                            {% for m in mouvements %}
                            <div class="list-group-item d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas 
                                        {% if m.type_mouvement in ['depot', 'transfert_entrant', 'transfert_depuis_sous_compte'] %} 
                                            fa-plus-circle text-success
                                        {% elif m.type_mouvement in ['retrait', 'transfert_sortant', 'transfert_vers_sous_compte'] %} 
                                            fa-minus-circle text-danger
                                        {% else %} 
                                            fa-exchange-alt text-primary
                                        {% endif %}">
                                    </i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-0">
                                            {% if m.type == 'transaction' %}
                                            {% if m.type_mouvement == 'depot' %}Dépôt
                                            {% elif m.type_mouvement == 'retrait' %}Retrait
                                            {% elif m.type_mouvement == 'transfert_vers_sous_compte' %}Vers {{
                                            m.sous_compte }}
                                            {% elif m.type_mouvement == 'transfert_depuis_sous_compte' %}Depuis {{
                                            m.sous_compte }}
                                            {% else %}{{ m.type_mouvement|replace('_', ' ')|title }}{% endif %}
                                            {% else %}
                                            {% if m.type_mouvement == 'transfert_entrant' %}Transfert entrant
                                            {% else %}Transfert sortant{% endif %}
                                            {% if m.sous_compte_source or m.sous_compte_dest %}
                                            ({{ m.sous_compte_source or m.sous_compte_dest }})
                                            {% endif %}
                                            {% endif %}
                                        </h6>
                                        <span class="{{ 'text-success' if m.montant > 0 else 'text-danger' }}">
                                            {{ '+' if m.montant > 0 else '' }}{{ "%.2f"|format(m.montant) }} {{
                                            compte.devise }}
                                        </span>
                                    </div>
                                    <small class="text-muted">
                                        {{ m.date.strftime('%d/%m/%Y %H:%M') }}
                                        {% if m.description %}<br>{{ m.description }}{% endif %}
                                    </small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-history fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Aucune activité récente</p>
                        </div>
                        {% endif %}
                    </div>
                    {% if mouvements|length >= 20 %}
                    <div class="card-footer text-center">
                        <a href="#" class="btn btn-outline-primary btn-sm">Voir toute l'activité</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Graphiques -->
        <!-- Section Graphique : Répartition des soldes -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>Répartition des soldes
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartRepartition" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- Trésorerie-->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Trésorerie - {{ libelle_periode }} </h5>

                        <!-- Sélecteur de période (sans JS) -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                {{ libelle_periode }}
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                <li><a class="dropdown-item" href="?periode=mois">Ce mois</a></li>
                                <li><a class="dropdown-item" href="?periode=trimestre">Ce trimestre</a></li>
                                <li><a class="dropdown-item" href="?periode=annee">Cette année</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="chartTresorerie" style="max-height: 250px;"></canvas>
                        <div class="mt-3">
                            <div class="d-flex justify-content-between">
                                <span class="text-success">
                                    <i class="fas fa-arrow-up me-1"></i>
                                    Total recettes: {{ "%.2f"|format(total_recettes) }} {{ compte.devise }}
                                </span>
                                <span class="text-danger">
                                    <i class="fas fa-arrow-down me-1"></i>
                                    Total dépenses: {{ "%.2f"|format(total_depenses) }} {{ compte.devise }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Navigation -->
        <div class="mt-4">
            <a href="{{ url_for('banking_dashboard') }}" class="btn btn-outline-secondary"><i
                    class="fas fa-arrow-left me-2"></i>Retour au tableau de bord</a>
        </div>
    </div>
</div>

<!-- Modal Transfert -->
<div class="modal fade" id="transfertRapideModal" tabindex="-1" aria-labelledby="transfertModalTitle"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('banking_transfert') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="transfertModalTitle"><i class="fas fa-exchange-alt me-2"></i>Transfert
                        rapide</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Montant ({{ compte.devise }})</label>
                        <input type="number" name="montant" class="form-control" step="0.01" min="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (optionnel)</label>
                        <input type="text" name="description" class="form-control" placeholder="Ex: Épargne mensuelle">
                    </div>
                    <input type="hidden" name="compte_id" value="{{ compte.id }}">
                    <input type="hidden" name="sous_compte_id" id="modalSousCompteId">
                    <input type="hidden" name="type_transfert" id="modalTypeTransfert">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-paper-plane me-2"></i>Effectuer le
                        transfert</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function transfertRapide(compteId, sousCompteId) {
        document.getElementById('modalSousCompteId').value = sousCompteId;
        document.getElementById('modalTypeTransfert').value = 'vers_sous_compte';
        new bootstrap.Modal(document.getElementById('transfertRapideModal')).show();
    }

    function retraitRapide(compteId, sousCompteId) {
        document.getElementById('modalSousCompteId').value = sousCompteId;
        document.getElementById('modalTypeTransfert').value = 'depuis_sous_compte';
        new bootstrap.Modal(document.getElementById('transfertRapideModal')).show();
    }
</script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('chartRepartition').getContext('2d');

        const labels = ['Compte principal', {% for sous_compte in sous_comptes %}'{{ sous_compte.nom_sous_compte }}', {% endfor %}];
    const data = [{{ compte.solde }}, {% for sous_compte in sous_comptes %} { { sous_compte.solde } }, {% endfor %}];
    const colors = ['{{ compte.couleur_banque }}', {% for sous_compte in sous_comptes %}'{{ sous_compte.couleur }}', {% endfor %}];

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            let value = context.parsed;
                            return value.toFixed(2) + ' {{ compte.devise }}';
                        }
                    }
                }
            }
        }
    });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('chartTresorerie');
        if (ctx) {
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Recettes', 'Dépenses'],
                    datasets: [{
                        data: [{{ total_recettes| float }}, {{ total_depenses| float }}
    }
    }],
        backgroundColor: ['#28a745', '#dc3545']
                }]
            },
        options: {
        responsive: true,
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: function (context) {
                        return context.raw.toFixed(2) + ' {{ compte.devise }}';
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function (value) {
                        return value + ' {{ compte.devise }}';
                    }
                }
            }
        }
    }
        });
    }
});
</script>
{% endblock %}