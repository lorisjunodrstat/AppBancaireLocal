{% extends "base.html" %}

{% block title %}Planning hebdomadaire{% endblock %}

{% block content %}

<h2>Planning ‚Äî Semaine du {{ week_dates[0].strftime('%d/%m/%Y') }} au {{ week_dates[-1].strftime('%d/%m/%Y') }}</h2>

<div style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
    <form method="post" action="{{ url_for('banking.planning_simulation_semaine') }}">
        <input type="hidden" name="annee" value="{{ annee }}">
        <input type="hidden" name="mois" value="{{ mois }}">
        <input type="hidden" name="semaine" value="{{ semaine }}">
        <input type="hidden" name="mode" value="{{ mode }}">
        <input type="hidden" name="employeur" value="{{ employeur }}">
        <input type="hidden" name="id_contrat" value="{{ id_contrat }}">
        <button type="submit" class="btn btn-info btn-sm">Simuler semaine</button>
    </form>

    <form method="post" action="{{ url_for('banking.planning_reset_semaine') }}"
        onsubmit="return confirm('R√©initialiser toute la semaine ?')">
        <input type="hidden" name="annee" value="{{ annee }}">
        <input type="hidden" name="mois" value="{{ mois }}">
        <input type="hidden" name="semaine" value="{{ semaine }}">
        <input type="hidden" name="mode" value="{{ mode }}">
        <input type="hidden" name="employeur" value="{{ employeur }}">
        <input type="hidden" name="id_contrat" value="{{ id_contrat }}">
        <button type="submit" class="btn btn-warning btn-sm">R√©initialiser semaine</button>
    </form>
</div>

{% if not employes %}
<div class="alert alert-info">
    Aucun employ√© n‚Äôest affect√© √† ce contrat. <a
        href="{{ url_for('banking.liste_employe', user_id=current_user.id) }}">Ajouter un employ√©</a>.
</div>
{% else %}
{% for employe in employes %}
<div style="margin-bottom: 2rem; border: 1px solid #ddd; padding: 1rem; border-radius: 4px;">
    <h3>{{ employe.prenom }} {{ employe.nom }}</h3>

    <div style="display: flex;">
        <!-- Colonne fixe : nom de l'employ√© -->
        <div style="width: 180px; font-weight: bold; padding: 8px 4px; background: #f8f9fa;">
            Employ√©
        </div>

        {% for day in week_dates %}
        {% set day_key = day.strftime('%Y-%m-%d') %}
        {% set shifts = shifts_by_employe_jour.get(employe.id, {}).get(day_key, []) %}
        {% set total_jour = totals.get(employe.id, {}).get(day_key, 0) %}

        <div style="flex: 1; min-width: 120px; padding: 4px; border: 1px solid #eee; position: relative;">
            <!-- En-t√™te -->
            <div style="font-weight: bold; text-align: center; margin-bottom: 4px;">
                {{ day.strftime('%a %d') }}
            </div>

            <!-- Grille horaire (6h ‚Üí 23h) -->
            <div style="height: 260px; position: relative; font-size: 0.7em;">
                {% for h in range(6, 24) %}
                <div
                    style="height: 15px; border-bottom: 1px solid #f0f0f0; color: #999; text-align: right; padding-right: 2px;">
                    {{ h }}h
                    <!-- Affichage des shifts -->
                    {% for shift in shifts %}
                    {% if shift.debut and shift.fin and h == shift.debut|int %}
                    <div style="
                          position: absolute;
                          top: 0;
                          left: 0;
                          right: 32px;
                          height: {{ (shift.duree * 15) }}px;
                          background: {% if shift.type == 'pause' %}#9E9E9E{% elif shift.valide %}#4CAF50{% else %}#F44336{% endif %};
                          color: white;
                          padding: 1px 2px;
                          font-weight: bold;
                          white-space: nowrap;
                          overflow: hidden;
                          border-radius: 2px;
                          z-index: 10;
                      ">
                        {{ shift.debut }}‚Äì{{ shift.fin }}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endfor %}
            </div>

            <!-- R√©sum√© + actions -->
            <div style="margin-top: 4px; font-size: 0.85em;">
                {% if total_jour > 0 %}
                <div><strong>{{ "%.1f"|format(total_jour) }} h</strong></div>
                {% endif %}

                <!-- Actions : modifier / copier / supprimer -->
                <div
                    style="position: absolute; top: 4px; right: 4px; display: flex; flex-direction: column; gap: 2px; font-size: 0.8em;">
                    <!-- Modifier -->
                    <form method="post" action="{{ url_for('banking.planning_modifier_jour') }}" style="margin: 0;">
                        <input type="hidden" name="employe_id" value="{{ employe.id }}">
                        <input type="hidden" name="date" value="{{ day_key }}">
                        <input type="hidden" name="annee" value="{{ annee }}">
                        <input type="hidden" name="mois" value="{{ mois }}">
                        <input type="hidden" name="semaine" value="{{ semaine }}">
                        <input type="hidden" name="mode" value="{{ mode }}">
                        <input type="hidden" name="employeur" value="{{ employeur }}">
                        <input type="hidden" name="id_contrat" value="{{ id_contrat }}">
                        <button type="submit"
                            style="padding: 1px 4px; background: #d4edda; border: 1px solid #ccc; font-size: 0.8em;">‚úèÔ∏è</button>
                    </form>

                    <!-- Copier vers un autre jour -->
                    <form method="post" action="{{ url_for('banking.planning_copier_jour') }}" style="margin: 0;">
                        <input type="hidden" name="source_date" value="{{ day_key }}">
                        <input type="hidden" name="employe_id" value="{{ employe.id }}">
                        <input type="hidden" name="annee" value="{{ annee }}">
                        <input type="hidden" name="mois" value="{{ mois }}">
                        <input type="hidden" name="semaine" value="{{ semaine }}">
                        <input type="hidden" name="mode" value="{{ mode }}">
                        <input type="hidden" name="employeur" value="{{ employeur }}">
                        <input type="hidden" name="id_contrat" value="{{ id_contrat }}">
                        <label><input type="date" name="target_date" required
                                style="font-size: 0.7em; width: 80px;"></label>
                        <button type="submit"
                            style="padding: 1px 4px; background: #e9ecef; border: 1px solid #ccc; font-size: 0.8em;">üìã</button>
                    </form>

                    <!-- Supprimer -->
                    <form method="post" action="{{ url_for('banking.planning_supprimer_jour') }}" style="margin: 0;">
                        <input type="hidden" name="employe_id" value="{{ employe.id }}">
                        <input type="hidden" name="date" value="{{ day_key }}">
                        <input type="hidden" name="annee" value="{{ annee }}">
                        <input type="hidden" name="mois" value="{{ mois }}">
                        <input type="hidden" name="semaine" value="{{ semaine }}">
                        <input type="hidden" name="mode" value="{{ mode }}">
                        <input type="hidden" name="employeur" value="{{ employeur }}">
                        <input type="hidden" name="id_contrat" value="{{ id_contrat }}">
                        <button type="submit"
                            style="padding: 1px 4px; background: #f8d7da; border: 1px solid #ccc; color: #721c24; font-size: 0.8em;"
                            onclick="return confirm('Supprimer ce jour ?')">üóëÔ∏è</button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endfor %}
{% endif %}

{% endblock %}

