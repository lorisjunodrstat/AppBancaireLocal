{% extends "base.html" %}

{% block title %}Planning hebdomadaire{% endblock %}

{% block content %}
<h2>Planning — Semaine du {{ week_dates[0].strftime('%d/%m/%Y') }} au {{ week_dates[-1].strftime('%d/%m/%Y') }}</h2>

<div style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
    <form method="post" action="{{ url_for('banking.planning_simulation_semaine') }}">
        <input type="hidden" name="annee" value="{{ annee }}">
        <input type="hidden" name="mois" value="{{ mois }}">
        <input type="hidden" name="semaine" value="{{ semaine }}">
        <input type="hidden" name="mode" value="{{ mode }}">
        <input type="hidden" name="employeur" value="{{ employeur }}">
        <input type="hidden" name="id_contrat" value="{{ id_contrat or '' }}">
        <button type="submit" class="btn btn-info btn-sm">Simuler semaine</button>
    </form>

    <form method="post" action="{{ url_for('banking.planning_reset_semaine') }}"
        onsubmit="return confirm('Réinitialiser toute la semaine ?')">
        <input type="hidden" name="annee" value="{{ annee }}">
        <input type="hidden" name="mois" value="{{ mois }}">
        <input type="hidden" name="semaine" value="{{ semaine }}">
        <input type="hidden" name="mode" value="{{ mode }}">
        <input type="hidden" name="employeur" value="{{ employeur }}">
        <input type="hidden" name="id_contrat" value="{{ id_contrat or '' }}">
        <button type="submit" class="btn btn-warning btn-sm">Réinitialiser semaine</button>
    </form>
</div>

{% if not employes %}
<div class="alert alert-info">
    Aucun employé n'est affecté à ce contrat. <a
        href="{{ url_for('banking.liste_employe', user_id=current_user.id) }}">Ajouter un employé</a>.
</div>
{% else %}
<!-- Tableau avec employés en colonnes et heures en lignes -->
<div style="overflow-x: auto;">
    <table style="border-collapse: collapse; width: 100%;">
        <thead>
            <tr>
                <th
                    style="width: 100px; padding: 8px; background: #f8f9fa; border: 1px solid #ddd; text-align: center;">
                    Heure
                </th>
                {% for day in week_dates %}
                <th style="padding: 8px; background: #f8f9fa; border: 1px solid #ddd; text-align: center;">
                    {{ day.strftime('%a %d') }}
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for hour in range(6, 24) %}
            <tr>
                <td
                    style="padding: 4px; border: 1px solid #eee; text-align: center; background: #f9f9f9; font-size: 0.9em;">
                    <strong>{{ hour }}h</strong>
                </td>

                {% for day in week_dates %}
                {% set day_key = day.strftime('%Y-%m-%d') %}
                <td style="padding: 2px; border: 1px solid #eee; min-height: 60px; vertical-align: top;">
                    <!-- Pour chaque employé, afficher ses shifts à cette heure -->
                    {% for employe in employes %}
                    {% set shifts = shifts_by_employe_jour.get(employe.id, {}).get(day_key, []) %}

                    {% for shift in shifts %}
                    {% if shift.debut and shift.fin %}
                    {% set shift_start = shift.debut|int %}
                    {% set shift_end = shift.fin|int %}

                    {% if hour >= shift_start and hour < shift_end %} <div style="
                        margin: 1px 0;
                        padding: 2px 4px;
                        background: {% if shift.type == 'pause' %}#9E9E9E{% elif shift.valide|default(true) %}#4CAF50{% else %}#F44336{% endif %};
                        color: white;
                        border-radius: 3px;
                        font-size: 0.8em;
                        font-weight: bold;
                        cursor: pointer;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    " title="{{ employe.prenom }} {{ employe.nom }}: {{ shift.debut }}h-{{ shift.fin }}h
Type: {{ shift.type|default('shift') }}
{% if shift.commentaire %}Commentaire: {{ shift.commentaire }}{% endif %}">
                        <div style="display: flex; justify-content: space-between;">
                            <span>{{ employe.prenom[:1] }}.{{ employe.nom[:3] }}</span>
                            <span>{{ shift.debut }}h-{{ shift.fin }}h</span>
                        </div>
                        {% if shift.commentaire %}
                        <div style="font-size: 0.7em; font-style: italic;">{{ shift.commentaire[:20] }}{% if
                            shift.commentaire|length > 20 %}...{% endif %}</div>
                        {% endif %}
</div>
{% endif %}
{% endif %}
{% endfor %}

{% endfor %}

<!-- Actions pour ajouter un shift -->
<div style="margin-top: 2px;">
    <form method="post" action="{{ url_for('banking.planning_ajouter_shift') }}" style="display: inline;">
        <input type="hidden" name="date" value="{{ day_key }}">
        <input type="hidden" name="heure_debut" value="{{ hour }}">
        <input type="hidden" name="heure_fin" value="{{ hour + 1 }}">
        <input type="hidden" name="employe_id" value="">
        <input type="hidden" name="annee" value="{{ annee }}">
        <input type="hidden" name="mois" value="{{ mois }}">
        <input type="hidden" name="semaine" value="{{ semaine }}">
        <input type="hidden" name="mode" value="{{ mode }}">
        <input type="hidden" name="employeur" value="{{ employeur }}">
        <input type="hidden" name="id_contrat" value="{{ id_contrat or '' }}">
        <button type="submit" style="font-size: 0.7em; padding: 1px 3px; opacity: 0.5;"
            title="Ajouter un shift à {{ hour }}h">
            +
        </button>
    </form>
</div>
</td>
{% endfor %}
</tr>
{% endfor %}
</tbody>
</table>
</div>

<!-- Légende -->
<div style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
    <h5>Légende :</h5>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <div><span style="display: inline-block; width: 20px; height: 10px; background: #4CAF50;"></span> Shift valide
        </div>
        <div><span style="display: inline-block; width: 20px; height: 10px; background: #F44336;"></span> Shift non
            valide</div>
        <div><span style="display: inline-block; width: 20px; height: 10px; background: #9E9E9E;"></span> Pause</div>
    </div>
</div>

<!-- Liste des employés -->
<div style="margin-top: 30px;">
    <h4>Employés :</h4>
    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
        {% for employe in employes %}
        <div style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
            <strong>{{ employe.prenom }} {{ employe.nom }}</strong>
            <div style="font-size: 0.8em; color: #666;">
                Heures totales semaine : {{ totals.get(employe.id, {}).total_semaine|default(0)|round(1) }}h
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% endblock %}