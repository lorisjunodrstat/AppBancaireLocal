{% extends "base.html" %}

{% set mois_noms = {
1: 'Janvier', 2: 'F√©vrier', 3: 'Mars', 4: 'Avril',
5: 'Mai', 6: 'Juin', 7: 'Juillet', 8: 'Ao√ªt',
9: 'Septembre', 10: 'Octobre', 11: 'Novembre', 12: 'D√©cembre'
} %}

{% block head_css %}
<style>
    .detail-calcul-section {
        margin-bottom: 1.5rem;
    }

    .calcul-ligne {
        display: flex;
        align-items: center;
        padding: 0.25rem 0;
    }

    .calcul-ligne.final {
        font-size: 1.1em;
        font-weight: bold;
    }

    .montant-positif {
        color: #28a745;
        font-weight: bold;
    }

    .montant-negatif {
        color: #dc3545;
        font-weight: bold;
    }

    .montant-neutre {
        color: #6c757d;
        font-weight: bold;
    }

    .section-icon {
        color: #6c757d;
    }

    .border-top {
        border-top: 2px solid #dee2e6 !important;
    }
</style>
{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="row">
            <h2>Calcul des salaires {{ tous_contrats|length }} tous_contrats {{ employeurs_unique|length }} employeurs
            </h2>
        </div>
        <form method="GET" class="d-flex align-items-center">
            <!-- Filtre Employeur -->
            <div class="me-3">
                <label class="form-label me-2">Employeur :</label>
                <select name="employeur" class="form-select" style="width: auto;">
                    <option value="">Tous les employeurs</option>
                    {% for emp in employeurs_unique %}
                    <option value="{{ emp }}" {% if selected_employeur==emp %}selected{% endif %}>
                        {{ emp }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Filtre Ann√©e -->
            <div class="me-3">
                <label class="form-label me-2">Ann√©e :</label>
                <select name="annee" class="form-select" style="width: auto;">
                    {% for year in range(annee_courante - 2, annee_courante + 3) %}
                    <option value="{{ year }}" {% if annee_courante==year %}selected{% endif %}>
                        {{ year }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <button type="submit" class="btn btn-outline-primary">
                <i class="fas fa-filter me-1"></i> Filtrer
            </button>
        </form>

        <div class="d-flex align-items-center">

            <!-- Bouton voir le contrat -->
            {% if contrat_actuel %}
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#contratModal">
                <i class="fas fa-file-contract me-1"></i> Voir le contrat
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Messages d'erreur/succ√®s sp√©cifiques √† cette page -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    {% if category == 'salaire_update' %}
    <div class="alert alert-{{ 'danger' if message.error else 'success' }} alert-dismissible fade show mb-4"
        role="alert">
        <i class="fas fa-{{ 'exclamation-triangle' if message.error else 'check-circle' }} me-2"></i>
        {{ message.text }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
    {% endfor %}
    {% endif %}
    {% endwith %}
    <div class="card mb-4">
        <div class="card-header bg-light">
            <div class="row">
                <div class="me-3">
                    <h5 class="m-0">R√©sultats pour {{ annee_courante }} chez {{ selected_employeur }}</h5>
                </div>
                <div class="me-3">
                    <form method="POST" action="{{ url_for('banking.recalculer_salaires') }}" style="display:inline;">
                        <input type="hidden" name="annee" value="{{ annee_courante }}">
                        <input type="hidden" name="employeur" value="{{ selected_employeur or '' }}">
                        {% if selected_employeur %}
                        <button type="submit" class="btn btn-warning btn-sm mb-3">
                            üîÅ Recalculer les estimations pour {{ selected_employeur }} ({{ annee_courante }})
                        </button>
                        {% else %}
                        <button type="submit" class="btn btn-secondary btn-sm mb-3" disabled>
                            üîÅ S√©lectionnez un employeur pour recalculer
                        </button>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle">
                    <thead class="table-light text-center">
                        <tr>
                            <th rowspan="2">Mois</th>
                            <th rowspan="2">Heures r√©elles</th>
                            <th rowspan="2">Heures hebdo</th>
                            <th colspan="3">Salaire</th>
                            <th colspan="4">Acomptes</th>
                            <th colspan="2">Simulation</th>
                            <th rowspan="2">Actions</th>
                        </tr>
                        <tr>
                            <th>Calcul√©</th>
                            <th>Salaire net</th>
                            <th>Vers√©</th>
                            <th>25</th>
                            <th>10</th>
                            <th>25 estim√©</th>
                            <th>10 estim√©</th>
                            <th>Diff√©rence</th>
                            <th>%</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mois in range(1, 13) %}
                        {% set data = salaires_par_mois.get(mois) %}
                        {% set salaire_data = data.employeurs.get(selected_employeur) if data and data.employeurs else
                        None %}
                        {% set has_data = salaire_data and salaire_data.heures_reelles and salaire_data.heures_reelles >
                        0 %}
                        <tr class="{{ 'table-secondary' if not has_data else '' }}">
                            <td class="text-center fw-bold">{{ mois_noms[mois] }}</td>

                            <!-- Heures r√©elles -->
                            <td class="text-center">
                                {{ "%.2f"|format(salaire_data.heures_reelles) if salaire_data and
                                salaire_data.heures_reelles is not none else '0.00' }}
                            </td>

                            <!-- Heures hebdomadaires -->
                            <td class="text-center">
                                {% if salaire_data and 'heures_hebdomadaires' in salaire_data and
                                salaire_data.heures_hebdomadaires is not none %}
                                {{ "%.2f"|format(salaire_data.heures_hebdomadaires) }}
                                {% else %}
                                {{ contrat_actuel.heures_hebdo if contrat_actuel else 38.0 }}
                                {% endif %}
                            </td>

                            <!-- Salaire calcul√© -->
                            <td class="text-center">
                                {{ "%.2f"|format(salaire_data.salaire_calcule) if salaire_data and
                                salaire_data.salaire_calcule is not none else
                                '0.00' }}
                                <span class="exxtrasmall" style="font-size: 6pt;">CHF</span>
                            </td>

                            <!-- Salaire net -->
                            <td class="text-center">
                                {{ "%.2f"|format(salaire_data.salaire_net) if salaire_data and salaire_data.salaire_net
                                is not none else '0.00' }}
                                <span class="exxtrasmall" style="font-size: 6pt;">CHF</span>
                            </td>

                            <!-- Salaire vers√© -->
                            <td class="text-center">
                                {{ "%.2f"|format(salaire_data.salaire_verse) if salaire_data and
                                salaire_data.salaire_verse is not none else '0.00'
                                }}
                                <span class="exxtrasmall" style="font-size: 6pt;">CHF</span>
                            </td>

                            <!-- Acompte 25 -->
                            <td class="text-center">
                                {{ "%.2f"|format(salaire_data.acompte_25) if salaire_data and salaire_data.acompte_25 is
                                not none else '0.00' }}
                                <span class="exxtrasmall" style="font-size: 6pt;">CHF</span>
                            </td>

                            <!-- Acompte 10 -->
                            <td class="text-center">
                                {{ "%.2f"|format(salaire_data.acompte_10) if salaire_data and salaire_data.acompte_10 is
                                not none else '0.00' }}
                                <span class="exxtrasmall" style="font-size: 6pt;">CHF</span>
                            </td>

                            <!-- Acompte 25 estim√© -->
                            <td class="text-center">
                                {{ "%.2f"|format(salaire_data.acompte_25_estime) if salaire_data and salaire_data.acompte_25_estime is not none else
                                '0.00' }}
                                <span class="exxtrasmall" style="font-size: 6pt;">CHF</span>
                            </td>

                            <!-- Acompte 10 estim√© -->
                            <td class="text-center">
                                {{ "%.2f"|format(salaire_data.acompte_10_estime) if salaire_data and salaire_data.acompte_10_estime is not none else
                                '0.00' }}
                                <span class="exxtrasmall" style="font-size: 6pt;">CHF</span>
                            </td>

                            <!-- Diff√©rence -->
                            <td class="text-center">
                                {% set difference = salaire_data.difference if salaire_data and salaire_data.difference
                                is not none else 0 %}
                                <span
                                    class="{{ 'text-success' if difference > 0 else 'text-danger' if difference < 0 else 'text-muted' }}">
                                    {{ "%.2f"|format(difference) }} CHF
                                </span>
                            </td>

                            <!-- Diff√©rence % -->
                            <td class="text-center">
                                {% set difference_pourcent = salaire_data.difference_pourcent if salaire_data and
                                salaire_data.difference_pourcent
                                is not none else 0 %}
                                <span
                                    class="{{ 'text-success' if difference_pourcent > 0 else 'text-danger' if difference_pourcent < 0 else 'text-muted' }}">
                                    {{ "%.2f"|format(difference_pourcent) }}
                                    <span class="exxtrasmall" style="font-size: 6pt;">%</span>
                                </span>
                            </td>

                            <!-- Actions -->
                            <td class="text-center">
                                <div class="btn-group" role="group">


                                    <!-- Bouton dropdown pour actions suppl√©mentaires (optionnel) -->
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                            style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size:.7rem"
                                            data-bs-toggle="dropdown" title="Plus d'actions">
                                            <i class="fas fa-ellipsis-v fs-6"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            {% if has_data %}
                                            <li>
                                                <button type="button" class="dropdown-item btn btn-sm btn-primary"
                                                    style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size:.7rem"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#editModal{{ mois }}{{ annee_courante }}"
                                                    title="Modifier les donn√©es">
                                                    <i class="fas fa-edit fs-6"></i>
                                                </button>
                                            </li>
                                            <li>
                                                <button type="button" class="dropdown-item btn btn-sm btn-primary"
                                                    style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .7rem"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#detailSalaireModal{{ mois }}{{ annee_courante }}"
                                                    aria-label="Voir les d√©tails du salaire pour {{ mois_noms[mois] }} {{ annee_courante }}"
                                                    title="Voir les d√©tails du salaire">
                                                    <i class="fas fa-eye me-2" aria-hidden="true"></i> Voir d√©tails
                                                </button>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="window.print()">
                                                    <i class="fas fa-print me-2"></i> Imprimer
                                                </a>
                                            </li>
                                            <li>
                                                <hr class="dropdown-divider">
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="#">
                                                    <i class="fas fa-file-export me-2"></i> Exporter PDF
                                                </a>
                                            </li>
                                            {% else %}
                                            <li>
                                                <span class="dropdown-item-text text-muted">
                                                    <i class="fas fa-info-circle me-2"></i> Aucune action disponible
                                                </span>
                                            </li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-active fw-bold text-end">
                        <tr>
                            <th class="text-start">Total</th>
                            <th>{{ "%.2f"|format(totaux.total_heures_reelles) }}</th>
                            <th></th>
                            <th>{{ "%.2f"|format(totaux.total_salaire_calcule) }} CHF</th>
                            <th>{{ "%.2f"|format(totaux.total_salaire_net) }} CHF</th>
                            <th>{{ "%.2f"|format(totaux.total_salaire_verse) }} CHF</th>
                            <th>{{ "%.2f"|format(totaux.total_acompte_25) }}</th>
                            <th>{{ "%.2f"|format(totaux.total_acompte_10) }}</th>
                            <th>{{ "%.2f"|format(totaux.total_acompte_25_estime) }}</th>
                            <th>{{ "%.2f"|format(totaux.total_acompte_10_estime) }}</th>
                            <th colspan="2">{{ "%.2f"|format(totaux.total_difference) }} CHF</th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    <div class="card mb-4">
        <div class="card-header">
            <h1>Graphiques de l'√©volution des salaires</h1>
        </div>
        <div class="card-body">
            {% if graphique1_svg %}
            <!-- Graphique 1 -->
            <svg width="{{ largeur_svg }}" height="{{ hauteur_svg }}" style="border: 1px solid #ccc; margin: 20px 0;">
                <!-- Axes -->
                <line x1="{{ margin_x }}" y1="{{ margin_y }}" x2="{{ margin_x }}" y2="{{ margin_y + plot_height }}"
                    stroke="black" />
                <line x1="{{ margin_x }}" y1="{{ margin_y + plot_height }}" x2="{{ margin_x + plot_width }}"
                    y2="{{ margin_y + plot_height }}" stroke="black" />
                <!-- Rep√®res sur l'axe Y -->
                {% for tick in graphique1_svg.ticks %}
                    {% if tick.is_major %}
                        <line x1="{{ graphique1_svg.margin_x - 6 }}" y1="{{ tick.y_px }}" x2="{{ graphique1_svg.margin_x }}"
                            y2="{{ tick.y_px }}" stroke="black" stroke-width="2" />
                        <text x="{{ graphique1_svg.margin_x - 8 }}" y="{{ tick.y_px + 4 }}" text-anchor="end" font-size="10">{{ tick.value
                            }}</text>
                        {% else %}
                        <line x1="{{ graphique1_svg.margin_x - 3 }}" y1="{{ tick.y_px }}" x2="{{ graphique1_svg.margin_x }}"
                            y2="{{ tick.y_px }}" stroke="black" stroke-width="1" />
                    {% endif %}
                {% endfor %}

                <!-- Colonnes (salaire estim√©) -->
                {% for col in graphique1_svg.colonnes %}
                <rect x="{{ col.x }}" y="{{ col.y }}" width="{{ col.width }}" height="{{ col.height }}"
                    fill="rgba(54, 162, 235, 0.5)" stroke="rgba(54, 162, 235, 0.8)" />
                {% endfor %}

                <!-- Ligne (salaire vers√©) -->
                <polyline points="{{ graphique1_svg.ligne_verse|join(' ') }}" fill="none" stroke="rgb(255, 99, 132)"
                    stroke-width="2" />

                <!-- Points acomptes -->
                {% for pt in graphique1_svg.points_acompte_10 %}
                <circle cx="{{ pt.split(',')[0] }}" cy="{{ pt.split(',')[1] }}" r="3" fill="green" />
                {% endfor %}
                {% for pt in graphique1_svg.points_acompte_25 %}
                <circle cx="{{ pt.split(',')[0] }}" cy="{{ pt.split(',')[1] }}" r="3" fill="orange" />
                {% endfor %}

                <!-- Labels mois (optionnel) -->
                {% for i in range(12) %}
                <text x="{{ margin_x + (i + 0.5) * (plot_width / 12) }}" y="{{ margin_y + plot_height + 20 }}"
                    text-anchor="middle" font-size="10">{{ graphique1_svg.mois_labels[i] }}</text>
                {% endfor %}
                !-- L√©gende -->
                <g font-size="12" transform="translate({{ margin_x + plot_width - 180 }}, {{ margin_y + 10 }})">
                    <!-- Salarie estim√© (barre) -->
                    <rect x="0" y="0" width="15" height="10" fill="rgba(54, 162, 235, 0.5)" stroke="rgba(54, 162, 235, 0.8)" />
                    <text x="20" y="10" alignment-baseline="middle">Salaire estim√©</text>
                
                    <!-- Salarie vers√© (ligne) -->
                    <line x1="0" y1="25" x2="15" y2="25" stroke="rgb(255, 99, 132)" stroke-width="2" />
                    <text x="20" y="25" alignment-baseline="middle">Salaire vers√©</text>
                
                    <!-- Acompte 10 % (point vert) -->
                    <circle cx="7.5" cy="45" r="4" fill="green" />
                    <text x="20" y="45" alignment-baseline="middle">Acompte 10 %</text>
                
                    <!-- Acompte 25 % (point orange) -->
                    <circle cx="7.5" cy="65" r="4" fill="orange" />
                    <text x="20" y="65" alignment-baseline="middle">Acompte 25 %</text>
                </g>
            </svg>
            {% else %}
            <p>Pas de graphique des acomptes</p>
            {% endif %}
            {% if graphique2_svg %}
            <!-- Graphique 2 -->
            <svg width="{{ largeur_svg }}" height="{{ hauteur_svg }}" style="border: 1px solid #ccc; margin: 20px 0;">
                <line x1="{{ margin_x }}" y1="{{ margin_y }}" x2="{{ margin_x }}" y2="{{ margin_y + plot_height }}"
                    stroke="black" />
                <line x1="{{ margin_x }}" y1="{{ margin_y + plot_height }}" x2="{{ margin_x + plot_width }}"
                    y2="{{ margin_y + plot_height }}" stroke="black" />

                <!-- Colonnes (total vers√©) -->
                {% for col in graphique2_svg.colonnes %}
                <rect x="{{ col.x }}" y="{{ col.y }}" width="{{ col.width }}" height="{{ col.height }}"
                    fill="rgba(75, 192, 192, 0.6)" stroke="rgba(75, 192, 192, 0.9)" />
                {% endfor %}

                <!-- Ligne (total estim√©) -->
                <polyline points="{{ graphique2_svg.ligne_estime|join(' ') }}" fill="none" stroke="rgb(255, 205, 86)"
                    stroke-width="2" />

                <!-- Labels mois -->
                {% for i in range(12) %}
                <text x="{{ margin_x + (i + 0.5) * (plot_width / 12) }}" y="{{ margin_y + plot_height + 20 }}"
                    text-anchor="middle" font-size="10">{{ graphique2_svg.mois_labels[i] }}</text>
                {% endfor %}
            </svg>
            {% else %}
            <p>Pas de graphique des salaires disponible pour l'instant</p>
            {% endif %}
        </div>
    </div>


    <!-- Modal pour afficher le contrat -->
    <div class="modal fade" id="contratModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Contrat utilis√© pour les calculs {% if selected_employeur %} chez {{
                        selected_employeur }} {% endif %} {{ contrat_actuel.employeur }}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="card">
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Employeur:</label>
                                    <p>{{ contrat_actuel.employeur }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p></p>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Heures hebdomadaires:</label>
                                <p>{{ contrat_actuel.heures_hebdo }}</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Salaire horaire:</label>
                                <p>{{ contrat_actuel.salaire_horaire }} CHF</p>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Date de d√©but:</label>
                                <p>{{ contrat_actuel.date_debut }}</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Date de fin:</label>
                                <p>{{ contrat_actuel.date_fin if contrat_actuel.date_fin else 'Ind√©termin√©e' }}</p>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Jour d'estimation:</label>
                                <p>{{ contrat_actuel.jour_estimation_salaire }} du mois</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Versements:</label>
                                <p>
                                    {% if contrat_actuel.versement_10 %}10{% endif %}
                                    {% if contrat_actuel.versement_10 and contrat_actuel.versement_25 %}, {% endif %}
                                    {% if contrat_actuel.versement_25 %}25{% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Taux d'indemnite vacances:</label>
                                <p>{{ contrat_actuel.indemnite_vacances_tx if contrat_actuel else 0.0 }} du mois</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Taux d'indemnite jours feries:</label>
                                <p> {{ contrat_actuel.indemnite_jours_feries_tx if contrat_actuel else 0.0 }}</p>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Taux d'indemnite jours de cong√©s:</label>
                                <p>{{ contrat_actuel.indemnite_jour_conges_tx if contrat_actuel else 0.0 }} du mois</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Taux de cotisation AVS:</label>
                                <p> {{ contrat_actuel.cotisation_avs_tx if contrat_actuel else 0.0 }}</p>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Taux de cotisation AC:</label>
                                <p>{{ contrat_actuel.cotisation_ac_tx if contrat_actuel else 0.0 }} du mois</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Taux d'accident non profesionnel:</label>
                                <p> {{ contrat_actuel.cotisation_accident_n_prof_tx if contrat_actuel else 0.0 }}</p>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Taux d'assurance indemnite maladie:</label>
                                <p>{{ contrat_actuel.cotisation_assurance_indemnite_maladie_tx if contrat_actuel else
                                    0.0 }} du mois</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Retenue pour CAP (2√®me piliers):</label>
                                <p> {{ contrat_actuel.cotisation_cap_tx if contrat_actuel else 0.0 }}</p>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Ce contrat est utilis√© pour tous les calculs de salaire et de simulation.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <a href="{{ url_for('banking.gestion_contrat') }}" class="btn btn-primary">
                    <i class="fas fa-edit me-1"></i> <small>Modifier le contrat</small>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modals pour modifier les valeurs - Un par mois -->
{% for mois in range(1, 13) %}
{% set data = salaires_par_mois.get(mois) %}
{% set salaire_data = data.employeurs.get(selected_employeur) if data and data.employeurs else None %}

<div class="modal fade" id="editModal{{ mois }}{{ annee_courante }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Modifier les valeurs pour {{ mois_noms[mois] }} {{ annee_courante }}
                    {% if selected_employeur %} chez {{ selected_employeur }} {% endif %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('banking.update_salaire') }}">
                <input type="hidden" name="mois" value="{{ mois }}">
                <input type="hidden" name="annee" value="{{ annee_courante }}">
                <input type="hidden" name="employeur" value="{{ selected_employeur }}">
                <input type="hidden" name="id_contrat"
                    value="{{ salaire_data.id_contrat if salaire_data and salaire_data.id_contrat else '' }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Salaire vers√© (CHF)</label>
                        <input type="number" step="0.01" class="form-control" name="salaire_verse"
                            value="{{ salaire_data.salaire_verse if salaire_data and salaire_data.salaire_verse is not none else '0.00' }}">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Acompte du 25 (CHF)</label>
                        <input type="number" step="0.01" class="form-control" name="acompte_25"
                            value="{{ salaire_data.acompte_25 if salaire_data and salaire_data.acompte_25 is not none else '0.00' }}">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Acompte du 10 (CHF)</label>
                        <input type="number" step="0.01" class="form-control" name="acompte_10"
                            value="{{ salaire_data.acompte_10 if salaire_data and salaire_data.acompte_10 is not none else '0.00' }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Modal pour le d√©tail du calcul -->
<div class="modal fade" id="detailSalaireModal{{ mois }}{{ annee_courante }}" tabindex="-1"
    aria-labelledby="detailSalaireModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    D√©tails du calcul - {{ mois_noms[mois] }} {{ annee_courante }}
                    {% if selected_employeur %} - {{ selected_employeur }}{% endif %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">

                {% if not salaire_data or not salaire_data.details %}
                <div class="alert alert-warning">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Aucune donn√©e disponible</h5>
                    <p>Les d√©tails du calcul ne sont pas disponibles pour ce mois.</p>
                </div>
                {% else %}

                {% set details_data = salaire_data.details %}
                {% set details_calcul = details_data.get('details', details_data) %}

                <!-- Section informations de base -->
                <div class="detail-calcul-section card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i> Informations de base</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="calcul-ligne">
                                    <i class="fas fa-clock me-2"></i>
                                    <span>Heures r√©elles travaill√©es:</span>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="fw-bold">{{ "%.2f"|format(details_calcul.get('heures_reelles', 0)) }}
                                    h</span>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="calcul-ligne">
                                    <i class="fas fa-coins me-2"></i>
                                    <span>Taux horaire:</span>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="fw-bold">{{ "%.2f"|format(details_calcul.get('salaire_horaire', 0)) }}
                                    CHF/h</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="calcul-ligne">
                                    <i class="fas fa-calculator me-2"></i>
                                    <span>Salaire brut:</span>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="fw-bold text-success">{{ "%.2f"|format(details_calcul.get('salaire_brut', 0))
                                    }} CHF</span>
                            </div>
                        </div>
                    </div>
                </div>

                

                <!-- Section indemnit√©s -->
                <div class="detail-calcul-section card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i> Indemnit√©s (ajout√©es au salaire)</h5>
                    </div>
                    <div class="card-body">
                        {% set indemnites = details_calcul.get('indemnites', {}) %}
                        {% set has_active_indemnites = false %}

                        {% for key, info in indemnites.items() %}
                        {% if info.actif and info.montant > 0 %}
                        {% set has_active_indemnites = true %}
                        <div class="row mb-3">
                            <div class="col-md-7">
                                <div class="calcul-ligne">
                                    <i class="fas fa-gift me-2"></i>
                                    <span>{{ info.nom }}</span>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="text-muted small">({{ "%.2f"|format(info.get('taux', 0)) }}%)</span>
                            </div>
                            <div class="col-md-3 text-end">
                                <span class="text-success">+ {{ "%.2f"|format(info.get('montant', 0)) }} CHF</span>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}

                        {% if not has_active_indemnites %}
                        <div class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            <em>Aucune indemnit√© active</em>
                        </div>
                        {% else %}
                        <div class="row mt-3 pt-2 border-top">
                            <div class="col-md-9">
                                <div class="calcul-ligne fw-bold">
                                    <i class="fas fa-plus-square me-2"></i>
                                    <span>Total indemnit√©s:</span>
                                </div>
                            </div>
                            <div class="col-md-3 text-end">
                                <span class="fw-bold text-success">+ {{
                                    "%.2f"|format(details_calcul.get('total_indemnites', 0)) }} CHF</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Section cotisations -->
                <div class="detail-calcul-section card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-minus-circle me-2"></i> Cotisations sociales (d√©duites du
                            salaire)</h5>
                    </div>
                    <div class="card-body">
                        {% set cotisations = details_calcul.get('cotisations', {}) %}
                        {% set has_active_cotisations = false %}

                        {% for key, info in cotisations.items() %}
                        {% if info.montant > 0 %}
                        {% set has_active_cotisations = true %}
                        <div class="row mb-3">
                            <div class="col-md-7">
                                <div class="calcul-ligne">
                                    <i class="fas fa-university me-2"></i>
                                    <span>{{ info.nom }}</span>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="text-muted small">
                                    ({{ "%.2f"|format(info.taux|default(0)) }}{{ ' CHF' if info.taux|default(0) >= 10
                                    else '%' }})
                                </span>
                            </div>
                            <div class="col-md-3 text-end">
                                <span class="text-danger">- {{ "%.2f"|format(info.get('montant', 0)) }} CHF</span>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}

                        {% if not has_active_cotisations %}
                        <div class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            <em>Aucune cotisation active</em>
                        </div>
                        {% else %}
                        <div class="row mt-3 pt-2 border-top">
                            <div class="col-md-9">
                                <div class="calcul-ligne fw-bold">
                                    <i class="fas fa-minus-square me-2"></i>
                                    <span>Total cotisations:</span>
                                </div>
                            </div>
                            <div class="col-md-3 text-end">
                                <span class="fw-bold text-danger">- {{
                                    "%.2f"|format(details_calcul.get('total_cotisations', 0)) }} CHF</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Section versements -->
                <div class="detail-calcul-section card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i> Versements anticip√©s</h5>
                    </div>
                    <div class="card-body">
                        {% set versements = details_calcul.get('versements', {}) %}
                        {% set has_active_versements = false %}

                        {% for key, info in versements.items() %}
                        {% if info.get('actif', False) and info.get('montant', 0) > 0 %}
                        {% set has_active_versements = true %}
                        <div class="row mb-3">
                            <div class="col-md-7">
                                <div class="calcul-ligne">
                                    <i class="fas fa-calendar-check me-2"></i>
                                    <span>{{ info.nom }}</span>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="text-muted small">vers√© le {{ "%.0f"|format(info.get('taux', 0)) }}</span>
                            </div>
                            <div class="col-md-3 text-end">
                                <span class="text-danger">- {{ "%.2f"|format(info.get('montant', 0)) }} CHF</span>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}

                        {% if not has_active_versements %}
                        <div class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            <em>Aucun versement configur√©</em>
                        </div>
                        {% else %}
                        <div class="row mt-3 pt-2 border-top">
                            <div class="col-md-9">
                                <div class="calcul-ligne fw-bold">
                                    <i class="fas fa-calendar-times me-2"></i>
                                    <span>Total versements:</span>
                                </div>
                            </div>
                            <div class="col-md-3 text-end">
                                <span class="fw-bold text-danger">- {{
                                    "%.2f"|format(details_calcul.get('total_versements', 0)) }} CHF</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Calcul final √©tape par √©tape -->
                <div class="detail-calcul-section card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-calculator me-2"></i> Calcul final √©tape par √©tape</h5>
                    </div>
                    <div class="card-body">
                        {% set calcul_final = details_calcul.get('calcul_final', {}) %}

                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="calcul-ligne">
                                    <i class="fas fa-money-bill-wave me-2"></i>
                                    <span>1. Salaire brut:</span>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="fw-bold">{{ "%.2f"|format(calcul_final.get('brut',
                                    details_calcul.get('salaire_brut', 0))) }} CHF</span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="calcul-ligne">
                                    <i class="fas fa-plus me-2 text-success"></i>
                                    <span>2. + Indemnit√©s:</span>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="fw-bold text-success">+ {{
                                    "%.2f"|format(details_calcul.get('total_indemnites', 0)) }} CHF</span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="calcul-ligne">
                                    <i class="fas fa-minus me-2 text-danger"></i>
                                    <span>3. - Cotisations:</span>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="fw-bold text-danger">- {{
                                    "%.2f"|format(details_calcul.get('total_cotisations', 0)) }} CHF</span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="calcul-ligne">
                                    <i class="fas fa-minus me-2 text-danger"></i>
                                    <span>4. Versements:</span>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="fw-bold text-danger"> {{
                                    "%.2f"|format(details_calcul.get('total_versements', 0)) }} CHF</span>
                            </div>
                        </div>

                        <div class="row mt-4 pt-3 border-top">
                            <div class="col-md-8">
                                <div class="calcul-ligne final fw-bold fs-5">
                                    <i class="fas fa-award me-2 text-primary"></i>
                                    <span>SALAIRE NET FINAL:</span>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="fw-bold fs-5 text-primary">{{ "%.2f"|format(salaire_data.salaire_net + details_calcul.get('total_versements')) }}
                                    CHF</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section debug (optionnelle - √† cacher en production) -->
                {% if config.DEBUG %}
                <div class="detail-calcul-section card">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0"><i class="fas fa-bug me-2"></i> Informations de d√©bogage</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12">
                                <p><strong>ID Contrat:</strong> {{ salaire_data.id_contrat if salaire_data else 'N/A' }}
                                </p>
                                <p><strong>Acompte 25 estim√©:</strong> {{ "%.2f"|format(salaire_data.acompte_25_estime)
                                    if salaire_data else '0.00' }} CHF</p>
                                <p><strong>Acompte 10 estim√©:</strong> {{ "%.2f"|format(salaire_data.acompte_10_estime)
                                    if salaire_data else '0.00' }} CHF</p>
                                <p><strong>Structure details_data:</strong> {{ details_data.keys()|list }}</p>
                                <p><strong>Structure details_calcul:</strong> {{ details_calcul.keys()|list if
                                    details_calcul else 'N/A' }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% endif %} <!-- Fin du if salaire_data.details -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i> Fermer
                </button>
                <button onclick="window.print()" class="btn btn-info">
                    <i class="fas fa-print me-2"></i> Imprimer
                </button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
</div>

{% endblock %}