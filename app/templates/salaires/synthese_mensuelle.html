{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Synth√®se mensuelle</h1>

    <!-- Formulaire de filtres (GET) -->
    <form method="get" class="mb-4" aria-label="Filtrer la synth√®se">
        <div class="row g-2">
            <div class="col-md-auto">
                <label for="annee" class="form-label">Ann√©e</label>
                <input type="number" name="annee" id="annee" class="form-control" value="{{ current_annee }}" min="2020"
                    max="{{ now.year + 1 }}">
            </div>
            <div class="col-md-auto">
                <label for="mois" class="form-label">Mois</label>
                <select name="mois" id="mois" class="form-select">
                    <option value="">Tous les mois</option>
                    {% set month_names = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                    'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'] %}
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if m==current_mois %}selected{% endif %}>
                        {{ month_names[m-1] }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-auto">
                <label for="employeur" class="form-label">Employeur</label>
                <select name="employeur" id="employeur" class="form-select">
                    <option value="">Tous les employeurs</option>
                    {% for emp in employeurs_disponibles %}
                    <option value="{{ emp }}" {% if emp==selected_employeur %}selected{% endif %}>
                        {{ emp }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-auto">
                <label for="contrat" class="form-label">Contrat</label>
                <select name="contrat" id="contrat" class="form-select">
                    <option value="">Tous les contrats</option>
                    {% for c in contrats_disponibles %}
                    <option value="{{ c.id }}" {% if c.id==selected_contrat %}selected{% endif %}>
                        {{ c.nom }} ({{ c.employeur }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-auto d-flex align-items-end">
                <button type="submit" class="btn btn-primary">Filtrer</button>
            </div>
        </div>
    </form>

    <!-- Bouton de g√©n√©ration (POST) -->
    <!-- Bouton de g√©n√©ration (POST) -->
    <form method="post" action="{{ url_for('banking.generer_syntheses_mensuelles') }}" class="mb-4">
        <input type="hidden" name="annee" value="{{ current_annee }}">
        <button type="submit" class="btn btn-success"
            onclick="return confirm('G√©n√©rer toutes les synth√®ses mensuelles manquantes pour {{ current_annee }} ?')">
            üîÑ G√©n√©rer les synth√®ses manquantes
        </button>
    </form>

    <!-- ‚úÖ GRAPHIQUE SVG -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>√âvolution du salaire mensuel en {{ current_annee }} (CHF)</h5>
        </div>
        <div class="card-body">
            <svg width="{{ graphique_svg.largeur_svg }}" height="{{ graphique_svg.hauteur_svg }}"
                style="border: 1px solid #eee; background: #fafafa; border-radius: 4px;">
                <!-- Grille horizontale -->
                {% for tick in graphique_svg.ticks %}
                <line x1="{{ graphique_svg.margin_x }}" y1="{{ tick.y_px }}"
                    x2="{{ graphique_svg.margin_x + graphique_svg.plot_width }}" y2="{{ tick.y_px }}"
                    stroke="{% if tick.is_major %}#ccc{% else %}#eee{% endif %}" />
                <text x="{{ graphique_svg.margin_x - 10 }}" y="{{ tick.y_px + 4 }}" font-size="12" text-anchor="end"
                    fill="#666">{{ tick.value }}</text>
                {% endfor %}
    
                <!-- Barres : salaire r√©el -->
                {% for bar in graphique_svg.colonnes %}
                <rect x="{{ bar.x }}" y="{{ bar.y }}" width="{{ bar.width }}" height="{{ bar.height }}" fill="#2c3e50"
                    opacity="0.85" />
                {% endfor %}
    
                <!-- Ligne : salaire simul√© -->
                {% if graphique_svg.ligne_simule %}
                <polyline points="{{ graphique_svg.ligne_simule | join(' ') }}" fill="none" stroke="#e67e22"
                    stroke-width="2" />
                {% endif %}
    
                <!-- √âtiquettes des mois -->
                {% for i in range(12) %}
                <text x="{{ graphique_svg.margin_x + (i + 0.5) * (graphique_svg.plot_width / 12) }}"
                    y="{{ graphique_svg.margin_y + graphique_svg.plot_height + 20 }}" font-size="12" text-anchor="middle"
                    fill="#555">
                    {{ graphique_svg.mois_labels[i][:2] }}
                </text>
                {% endfor %}
            </svg>
        </div>
    </div>

        <div class="accordion" id="resulttable" projectAccordion">
            <!-- Planning Section -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                        <i class="fas fa-clipboard-list feature-icon"></i>
                        Tableau des r√©sultats
                    </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#resulttable">
                    <div class="accordion-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">Mois</th>
                                        <th scope="col">Ann√©e</th>
                                        <th scope="col">Employeur</th>
                                        <th scope="col">Contrat</th>
                                        <th scope="col" class="text-end">Heures r√©elles</th>
                                        <th scope="col" class="text-end">Heures simul√©es</th>
                                        <th scope="col" class="text-end">Salaire r√©el (CHF)</th>
                                        <th scope="col" class="text-end">Salaire simul√© (CHF)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if syntheses %}
                                    {% for s in syntheses %}
                                    <tr>
                                        <td>{{ month_names[s.mois - 1] }}</td>
                                        <td>{{ s.annee }}</td>
                                        <td>{{ s.employeur or '‚Äî' }}</td>
                                        <td>{{ s.id_contrat or '‚Äî' }}</td>
                                        <td class="text-end">{{ '%.2f'|format(s.heures_reelles or 0) }}</td>
                                        <td class="text-end">{{ '%.2f'|format(s.heures_simulees or 0) }}</td>
                                        <td class="text-end">{{ '%.2f'|format(s.salaire_reel or 0) }}</td>
                                        <td class="text-end">{{ '%.2f'|format(s.salaire_simule or 0) }}</td>
                                    </tr>
                                    {% endfor %}
                                    {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center fst-italic">Aucune synth√®se disponible</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Tableau des r√©sultats -->
    
</div>
{% endblock %}