{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Synth√®se hebdomadaire</h1>

    <!-- Formulaire de filtres (GET) -->
    <form method="get" class="mb-4" aria-label="Filtrer la synth√®se">
        <div class="row g-2">
            <div class="col-md-auto">
                <label for="annee" class="form-label">Ann√©e</label>
                <input type="number" name="annee" id="annee" class="form-control" value="{{ annee }}" min="2020"
                    max="{{ now.year + 1 }}">
            </div>
            <div class="col-md-auto">
                <label for="semaine" class="form-label">Semaine</label>
                <select name="semaine" id="semaine" class="form-select">
                    <option value="">Toutes les semaines</option>
                    {% for s in range(1, 54) %}
                    <option value="{{ s }}" {% if s==selected_semaine %}selected{% endif %}>
                        Semaine {{ s }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-auto">
                <label for="employeur" class="form-label">Employeur</label>
                <select name="employeur" id="employeur" class="form-select">
                    <option value="">Tous les employeurs</option>
                    {% for emp in employeurs %}
                    <option value="{{ emp }}" {% if emp==selected_employeur %}selected{% endif %}>
                        {{ emp }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-auto">
                <label for="contrat" class="form-label">Contrat</label>
                <select name="contrat" id="contrat" class="form-select">
                    <option value="">Tous les contrats</option>
                    {% for c in contrats %}
                    <option value="{{ c.id }}" {% if c.id==selected_contrat %}selected{% endif %}>
                        {{ c.nom }} ({{ c.employeur }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-auto d-flex align-items-end">
                <button type="submit" class="btn btn-primary">Filtrer</button>
            </div>
        </div>
    </form>

    <!-- Bouton de g√©n√©ration (POST) -->
    <form method="post" action="{{ url_for('banking.generer_syntheses_hebdomadaires') }}" class="mb-4">
        <input type="hidden" name="annee" value="{{ annee }}">
        <button type="submit" class="btn btn-success"
            onclick="return confirm('G√©n√©rer toutes les synth√®ses hebdomadaires manquantes pour {{ annee }} ?')">
            üîÑ G√©n√©rer les synth√®ses manquantes
        </button>
    </form>

    <!-- Tableau des r√©sultats -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th scope="col">Semaine</th>
                    <th scope="col">Ann√©e</th>
                    <th scope="col">Employeur</th>
                    <th scope="col">Contrat</th>
                    <th scope="col" class="text-end">Heures r√©elles</th>
                    <th scope="col" class="text-end">Heures simul√©es</th>
                    <th scope="col" class="text-end">Diff√©rence</th>
                    <th scope="col" class="text-end">Pourcentage</th>
                </tr>
            </thead>
            <tbody>
                {% if semaines %}
                {% for s in semaines %}
                <tr>
                    <td>Semaine {{ s.semaine_numero }}</td>
                    <td>{{ s.annee }}</td>
                    <td>{{ s.employeur or '‚Äî' }}</td>
                    <td>{{ s.id_contrat or '‚Äî' }}</td>
                    <td class="text-end">{{ '%.2f'|format(s.heures_reelles or 0) }} h</td>
                    <td class="text-end">{{ '%.2f'|format(s.heures_simulees or 0) }} h</td>
                    <td class="text-end">{{ '%.2f'|format(s.difference or 0) }} h</td>
                    {% set taux = (s.heures_reelles / 42.5 * 100) if s.heures_reelles else 0 %}
                    <td class="text-end" style="{% if taux <= 60 %}color: green{% elif taux <= 80 %}color: red{% else %}color:red;font-weight: bold{% endif %};">
                        {{ '%.1f%%'|format(taux) }}
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="7" class="text-center fst-italic">Aucune synth√®se disponible</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}